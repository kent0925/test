<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Garden Party</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #fefce8;
            /* Light Yellow bg for festive feel */
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .btn-press:active {
            transform: scale(0.96);
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-stone-50 text-stone-800 pb-20 selection:bg-orange-100">

    <!-- Loading Screen -->
    <div id="loading-screen"
        class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-stone-200 border-t-orange-500 mb-4"></div>
        <p class="text-stone-400 font-bold tracking-widest text-xs">LOADING</p>
    </div>

    <!-- Header (Sticky) -->
    <header
        class="fixed top-0 left-0 right-0 z-40 glass border-b border-stone-100 shadow-sm transition-all duration-300"
        id="header">
        <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <!-- Back Button (Hidden on Home) -->
                <button id="back-btn" onclick="goHome()"
                    class="hidden p-2 -ml-2 rounded-full hover:bg-stone-100 transition-colors">
                    <svg class="w-5 h-5 text-stone-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <!-- Title / Store Name -->
                <h1 id="page-title" class="font-black text-xl text-stone-800 tracking-tight flex items-center gap-2">
                    <span class="text-2xl">ğŸª</span> åœ’éŠæœƒä¸»æœƒå ´
                </h1>
            </div>

            <div class="flex items-center gap-2">
                <!-- Mode Toggle (Seller) -->
                <button onclick="toggleSellerMode()" id="seller-btn"
                    class="bg-orange-600 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-sm active:scale-95 flex items-center gap-1">
                    <span>æˆ‘è¦æ“ºæ”¤</span>
                </button>
                <!-- User Avatar -->
                <img id="user-avatar" src=""
                    class="w-8 h-8 rounded-full bg-stone-200 object-cover border border-stone-100 hidden">
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="max-w-md mx-auto pt-20 px-4 min-h-screen relative">

        <!-- VIEW: Platform Home (Store List) -->
        <main id="view-home" class="animate-fade-in space-y-6">
            <div class="space-y-1 px-1">
                <h2 class="text-2xl font-black text-stone-800">ç†±é¬§æ”¤ä½</h2>
                <p class="text-xs text-stone-500 font-bold">ä¾†çœ‹çœ‹å¤§å®¶éƒ½åœ¨è³£ä»€éº¼ï¼</p>
            </div>
            <!-- Store Grid -->
            <div id="store-list" class="grid grid-cols-1 gap-4 pb-10">
                <!-- Skeloton -->
                <div class="bg-white rounded-2xl p-4 shadow-sm h-32 animate-pulse bg-orange-100"></div>
            </div>
        </main>

        <!-- VIEW: Store Page (Products) -->
        <main id="view-store" class="hidden animate-fade-in space-y-6 pb-24">
            <!-- Store Cover Info -->
            <div id="store-header"
                class="bg-white rounded-3xl p-6 shadow-sm border border-stone-100 text-center space-y-2 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-orange-50 to-white -z-10"></div>
                <img id="store-cover-img" src=""
                    class="w-20 h-20 rounded-full mx-auto object-cover bg-stone-200 shadow-md mb-2">
                <h2 id="store-page-name" class="text-2xl font-black text-stone-800">Store Name</h2>
                <p id="store-page-desc" class="text-sm text-stone-500 font-bold">Store Description</p>
                <div class="flex justify-center gap-4 text-xs font-bold text-stone-400 pt-2">
                    <span id="store-ship-home">ğŸšš å®…é… $100</span>
                    <span id="store-ship-store">ğŸª è¶…å•† $60</span>
                </div>
            </div>

            <!-- Product Grid -->
            <div id="product-grid" class="grid grid-cols-2 gap-4">
                <!-- Products rendered here -->
            </div>
        </main>

        <!-- VIEW: Seller Dashboard -->
        <main id="view-seller" class="hidden animate-fade-in space-y-8 pb-24">
            <div class="flex justify-between items-end">
                <div class="space-y-1">
                    <h2 class="text-2xl font-black text-stone-800">æ”¤ä¸»ä¸­å¿ƒ</h2>
                    <p class="text-xs text-stone-500 font-bold">ä½ˆç½®æ‚¨çš„æ”¤ä½èˆ‡ä¸Šæ¶å•†å“</p>
                </div>
                <button onclick="goToStore(app.user.id)"
                    class="bg-orange-100 text-orange-600 px-3 py-1.5 rounded-lg text-xs font-bold active:scale-95 transition-transform">
                    é è¦½æ”¤ä½ âœ
                </button>
            </div>

            <!-- 1. Store Settings Module -->
            <section class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 space-y-4">
                <h3 class="font-bold text-lg flex items-center gap-2">ï¿½ æ”¤ä½ä½ˆç½®</h3>

                <div class="grid grid-cols-[auto_1fr] gap-4 items-center">
                    <div class="relative w-16 h-16 rounded-full bg-stone-100 overflow-hidden group cursor-pointer border-2 border-dashed border-stone-300 hover:border-orange-500 transition-colors"
                        onclick="document.getElementById('store-img-input').click()">
                        <img id="preview-store-img" class="w-full h-full object-cover hidden">
                        <div
                            class="absolute inset-0 flex items-center justify-center text-stone-400 group-hover:text-orange-500">
                            ğŸ“·</div>
                    </div>
                    <input type="file" id="store-img-input" accept="image/*" class="hidden"
                        onchange="handleStoreImage(this)">
                    <div class="space-y-2">
                        <input type="text" id="set-store-name" placeholder="æ”¤ä½åç¨± (å¦‚: 601ç­ ä¹¾å†°æ±½æ°´)"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-sm font-bold outline-none border border-transparent focus:border-stone-300">
                        <input type="text" id="set-store-desc" placeholder="æ”¤ä½ä»‹ç´¹ (ä¸€å¥è©±)"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-xs font-bold outline-none border border-transparent focus:border-stone-300">
                    </div>
                </div>

                <div class="space-y-2 pt-2 border-t border-stone-100">
                    <label class="text-xs font-bold text-stone-400">åŒ¯æ¬¾è³‡è¨Š</label>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="set-bank-code"
                            class="col-span-2 bg-stone-50 rounded-xl px-3 py-2 text-xs font-bold outline-none border border-transparent focus:border-stone-300">
                            <option value="">é¸æ“‡éŠ€è¡Œ</option>
                        </select>
                        <input type="tel" id="set-bank-acc" placeholder="éŠ€è¡Œå¸³è™Ÿ (åƒ…é™æ•¸å­—)"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-xs font-bold outline-none border border-transparent focus:border-stone-300">
                        <input type="text" id="set-bank-name" placeholder="æˆ¶å"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-xs font-bold outline-none border border-transparent focus:border-stone-300">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Home Delivery -->
                        <div
                            class="bg-stone-50 p-3 rounded-xl border border-transparent has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50 transition-colors">
                            <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                <input type="checkbox" id="enable-ship-home" onchange="toggleShipInput('home')"
                                    class="w-4 h-4 accent-orange-600">
                                <span class="text-xs font-bold text-stone-600">é–‹å•Ÿå®…é…</span>
                            </label>
                            <div class="flex items-center gap-1">
                                <span class="text-xs font-bold text-stone-400">$</span>
                                <input type="number" id="set-ship-home" value="100" min="0" placeholder="é‹è²»"
                                    oninput="if(this.value<0)this.value=0"
                                    class="w-full bg-transparent text-sm font-bold outline-none border-b border-stone-300 focus:border-orange-500">
                            </div>
                        </div>
                        <!-- CVS Delivery -->
                        <div
                            class="bg-stone-50 p-3 rounded-xl border border-transparent has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50 transition-colors">
                            <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                <input type="checkbox" id="enable-ship-store" onchange="toggleShipInput('store')"
                                    class="w-4 h-4 accent-orange-600">
                                <span class="text-xs font-bold text-stone-600">é–‹å•Ÿè¶…å•†</span>
                            </label>
                            <div class="flex items-center gap-1">
                                <span class="text-xs font-bold text-stone-400">$</span>
                                <input type="number" id="set-ship-store" value="60" min="0" placeholder="é‹è²»"
                                    oninput="if(this.value<0)this.value=0"
                                    class="w-full bg-transparent text-sm font-bold outline-none border-b border-stone-300 focus:border-orange-500">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <!-- Pickup Toggle -->
                        <div
                            class="col-span-2 bg-stone-50 p-3 rounded-xl border border-transparent has-[:checked]:border-orange-500 has-[:checked]:bg-orange-50 transition-colors">
                            <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                <input type="checkbox" id="enable-ship-pickup" onchange="togglePickupInput()"
                                    class="w-4 h-4 accent-orange-600">
                                <span class="text-xs font-bold text-stone-600">é–‹å•Ÿæ”¤ä½è‡ªå–</span>
                            </label>
                            <div class="grid grid-cols-1 gap-3">
                                <input type="text" id="set-pickup-loc" placeholder="è‡ªå–åœ°é» (ä¾‹: æ”¤ä½A01)" disabled
                                    class="w-full bg-transparent text-sm font-bold outline-none border-b border-stone-300 focus:border-orange-500 py-1">
                                <input type="text" id="set-pickup-tel" placeholder="è‡ªå–è¯çµ¡é›»è©±" inputmode="numeric" disabled
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                    class="w-full bg-transparent text-sm font-bold outline-none border-b border-stone-300 focus:border-orange-500 py-1">
                            </div>
                        </div>
                    </div>

                    <button onclick="saveStoreSettings()" id="btn-save-store"
                        class="w-full bg-stone-800 text-white font-bold py-3 rounded-xl text-sm btn-press">å„²å­˜æ”¤ä½è¨­å®š</button>
            </section>

            <!-- 2. Create Product Module -->
            <section class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 space-y-4">
                <h3 class="font-bold text-lg flex items-center gap-2">ğŸ“¦ ä¸Šæ¶æ–°å•†å“</h3>
                <form id="sell-form" class="space-y-4" onsubmit="event.preventDefault(); submitProduct();">
                    <!-- Image Upload -->
                    <div class="relative w-full aspect-video bg-stone-50 rounded-xl border-2 border-dashed border-stone-200 flex flex-col items-center justify-center cursor-pointer hover:border-orange-400 transition-colors overflow-hidden group"
                        onclick="document.getElementById('prod-img-input').click()">
                        <img id="preview-prod-img" class="absolute inset-0 w-full h-full object-cover hidden">
                        <div class="text-center group-hover:scale-110 transition-transform">
                            <span class="text-2xl">ğŸ“¸</span>
                            <p class="text-[10px] font-bold text-stone-400 mt-1">ä¸Šå‚³å•†å“ç…§</p>
                        </div>
                    </div>
                    <input type="file" id="prod-img-input" accept="image/*" class="hidden"
                        onchange="handleProdImage(this)">

                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="prod-name" required placeholder="å•†å“åç¨±"
                            class="col-span-2 w-full bg-stone-50 rounded-xl px-4 py-3 text-sm font-bold outline-none">
                        <input type="number" id="prod-price" required min="0" placeholder="åƒ¹æ ¼ (0=å…è²»)"
                            class="w-full bg-stone-50 rounded-xl px-4 py-3 text-sm font-bold outline-none">
                        <input type="text" id="prod-cat" required placeholder="åˆ†é¡" list="cat-list"
                            class="w-full bg-stone-50 rounded-xl px-4 py-3 text-sm font-bold outline-none">
                    </div>

                    <!-- Specs -->
                    <div class="bg-stone-50 p-3 rounded-xl space-y-2">
                        <div class="flex justify-between items-center"><span class="text-xs font-bold text-stone-400">è¦æ ¼
                                (é¸å¡«)</span> <button type="button" onclick="addSpecLine()"
                                class="text-orange-500 text-xs font-bold">+å¢åŠ </button></div>
                        <div id="specs-container" class="space-y-2">
                            <div class="flex gap-2"><input class="spec-key w-1/3 p-2 rounded text-xs" placeholder="é¡è‰²"
                                    value="æ¨£å¼"><input class="spec-vals flex-1 p-2 rounded text-xs" placeholder="ç´…,è—">
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="submit-prod-btn"
                        class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-200 btn-press">ç¢ºèªä¸Šæ¶</button>
                </form>
            </section>

            <!-- 3. Manage Products Module -->
            <section class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 space-y-4">
                <h3 class="font-bold text-lg flex items-center gap-2">ğŸ“‹ å·²ä¸Šæ¶å•†å“</h3>
                <div id="seller-product-list" class="space-y-3">
                    <p class="text-center text-stone-400 text-xs py-4">è¼‰å…¥ä¸­...</p>
                </div>
            </section>

            <!-- 4. Order Management (NEW) -->
            <section class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-lg flex items-center gap-2">ğŸ§¾ è¨‚å–®ç®¡ç†</h3>
                    <button onclick="fetchSellerOrders()"
                        class="bg-stone-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold">é‡æ–°æ•´ç†</button>
                </div>
                <div id="seller-order-list" class="space-y-3 max-h-80 overflow-y-auto pr-1">
                    <p class="text-center text-stone-400 text-xs py-4">å°šç„¡è¨‚å–®è³‡æ–™ (è«‹é»æ“Šé‡æ–°æ•´ç†)</p>
                </div>
            </section>
        </main>

        <!-- Order Detail & Print Modal -->
        <div id="order-modal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeOrderModal()"></div>
            <div
                class="absolute inset-x-4 top-10 bottom-10 bg-white rounded-2xl flex flex-col overflow-hidden shadow-2xl">
                <!-- Header -->
                <div class="p-4 border-b border-stone-100 flex justify-between items-center bg-stone-50">
                    <h3 class="font-black text-lg text-stone-800">è¨‚å–®å…§å®¹</h3>
                    <button onclick="closeOrderModal()"
                        class="w-8 h-8 rounded-full bg-white text-stone-500 font-bold shadow-sm">âœ•</button>
                </div>

                <!-- Content (Scrollable) -->
                <div id="order-modal-content" class="flex-1 overflow-y-auto p-4 bg-stone-50">
                    <!-- Receipt Preview Area (Target for html2canvas) -->
                    <div id="receipt-node"
                        class="bg-white p-6 rounded-none shadow-none mx-auto max-w-sm text-stone-900 leading-relaxed border border-stone-200">
                        <!-- Dynamic Content Inserted Here -->
                    </div>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t border-stone-100 bg-white flex gap-3">
                    <button onclick="printOrderImage()"
                        class="flex-1 bg-orange-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform">
                        ğŸ“¸ ç”¢ç”Ÿå‡ºè²¨å–®åœ–ç‰‡
                    </button>
                </div>
            </div>
        </div>

        <!-- Generated Image Modal -->
        <div id="img-modal" class="fixed inset-0 z-[60] hidden flex flex-col items-center justify-center p-6">
            <div class="absolute inset-0 bg-black/90"
                onclick="document.getElementById('img-modal').classList.add('hidden')"></div>
            <div class="relative z-10 w-full max-w-sm bg-stone-800 p-2 rounded-2xl shadow-2xl space-y-4">
                <p class="text-center text-white text-xs font-bold pt-2">è«‹é•·æŒ‰åœ–ç‰‡å„²å­˜ï¼Œæˆ–æˆªåœ–åˆ†äº«</p>
                <img id="generated-receipt-img" class="w-full rounded-xl bg-white">
                <button onclick="document.getElementById('img-modal').classList.add('hidden')"
                    class="w-full py-3 bg-white text-stone-900 font-bold rounded-xl">é—œé–‰</button>
            </div>
        </div>

    </div>

    <!-- Floating Cart Button (Visible in Store View) -->
    <div id="cart-float-btn"
        class="fixed bottom-6 left-0 right-0 z-30 pointer-events-none opacity-0 translate-y-20 transition-all duration-300">
        <div class="max-w-md mx-auto px-6 flex justify-center">
            <button onclick="openCart()"
                class="pointer-events-auto bg-stone-900 text-white rounded-full px-6 py-3 shadow-2xl flex items-center gap-3 active:scale-95 transition-transform">
                <div class="relative">
                    <span class="text-xl">ğŸ›’</span>
                    <span id="cart-count"
                        class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-stone-900">0</span>
                </div>
                <span class="font-bold pr-1">çµå¸³å»</span>
                <span id="cart-total-float" class="font-mono text-orange-300 pl-2 border-l border-stone-700">$0</span>
            </button>
        </div>
    </div>

    <!-- MODALS (Product, Cart) - Reuse logical structure -->
    <!-- (Simplified for brevity, ensuring critical logic is present) -->

    <!-- Product Detail Modal -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeProductModal()"></div>
        <div
            class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 transition-transform duration-300 translate-y-full transform max-h-[85vh] overflow-y-auto">
            <div class="w-12 h-1.5 bg-stone-200 rounded-full mx-auto mb-6"></div>
            <img id="modal-img" class="w-[150px] h-[150px] mx-auto object-cover rounded-2xl mb-4 bg-stone-100">
            <div class="space-y-4">
                <div>
                    <h3 id="modal-name" class="text-2xl font-black text-stone-800">Product</h3>
                    <p id="modal-price" class="text-xl font-bold text-orange-600">$0</p>
                </div>
                <!-- Specs -->
                <div id="modal-specs" class="space-y-3"></div>
                <!-- Qty -->
                <div class="flex items-center justify-between bg-stone-50 p-3 rounded-xl">
                    <span class="text-sm font-bold text-stone-500">æ•¸é‡</span>
                    <div class="flex items-center gap-4">
                        <button onclick="updateModalQty(-1)"
                            class="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center font-bold text-lg">-</button>
                        <span id="modal-qty" class="font-bold text-xl px-2">1</span>
                        <button onclick="updateModalQty(1)"
                            class="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center font-bold text-lg">+</button>
                    </div>
                </div>
                <button onclick="addToCart()"
                    class="w-full bg-stone-900 text-white font-bold py-4 rounded-2xl shadow-lg btn-press">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeCart()"></div>
        <div id="cart-panel"
            class="absolute bottom-0 left-0 right-0 bg-stone-50 h-[85vh] rounded-t-3xl flex flex-col transition-transform duration-300 translate-y-full shadow-2xl">
            <!-- Header -->
            <div
                class="bg-white px-6 py-4 rounded-t-3xl border-b border-stone-100 flex justify-between items-center flex-shrink-0">
                <h3 class="font-black text-xl text-stone-800">è³¼ç‰©è»Š</h3>
                <button onclick="clearCart()"
                    class="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-full">æ¸…ç©º</button>
            </div>
            <!-- Items -->
            <div id="cart-items-container" class="flex-grow overflow-y-auto p-4 space-y-3">
                <!-- Items Rendered Here -->
            </div>
            <!-- Checkout Footer -->
            <div class="bg-white p-6 border-t border-stone-100 flex-shrink-0 safe-pb">
                <!-- Checkout Forms (Condensed) -->
                <div class="space-y-4 pt-2 border-t border-stone-100">
                    <div class="flex gap-2">
                        <button onclick="setShipMethod('pickup')" id="btn-ship-pickup"
                            class="flex-1 py-2 rounded-xl text-xs font-bold bg-orange-100 text-orange-600 border border-orange-200">æ”¤ä½è‡ªå–</button>
                        <button onclick="setShipMethod('cvs')" id="btn-ship-cvs"
                            class="flex-1 py-2 rounded-xl text-xs font-bold bg-stone-50 text-stone-400 border border-transparent">è¶…å•†å–è²¨</button>
                        <button onclick="setShipMethod('home')" id="btn-ship-home"
                            class="flex-1 py-2 rounded-xl text-xs font-bold bg-stone-50 text-stone-400 border border-transparent">å®…é…åˆ°åºœ</button>
                    </div>

                    <!-- Pickup Info -->
                    <div id="ship-pickup-info" class="text-xs text-stone-500 bg-stone-50 p-3 rounded-xl">
                        <p class="font-bold mb-2">é ç´„è‡ªå–æ™‚é–“</p>
                        <input type="datetime-local" id="pickup-time"
                            class="w-full bg-white rounded-lg p-2 border border-stone-200 outline-none">
                        <p class="mt-2 text-[10px] text-stone-400">*è«‹æ–¼åœ’éŠæœƒç‡Ÿæ¥­æ™‚é–“å…§å‰å¾€æ”¤ä½å–è²¨</p>
                    </div>

                    <!-- CVS Pickup (Renamed from ship-store-info) -->
                    <div id="ship-cvs-info" class="text-xs text-stone-500 bg-stone-50 p-3 rounded-xl hidden">
                        <div>
                            <p class="font-bold mb-2">é¸æ“‡å–è²¨é–€å¸‚</p>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <select id="cvs-type" onchange="loadCVSCities()"
                                    class="bg-white rounded-lg p-2 border border-stone-200">
                                    <option value="7-11">7-11</option>
                                    <option value="FamilyMart">å…¨å®¶</option>
                                </select>
                                <select id="cvs-city" onchange="loadCVSStores()"
                                    class="bg-white rounded-lg p-2 border border-stone-200">
                                    <option>ç¸£å¸‚</option>
                                </select>
                                <select id="cvs-dist" onchange="filterCVSStores()"
                                    class="bg-white rounded-lg p-2 border border-stone-200 col-span-2">
                                    <option>å€åŸŸ</option>
                                </select>
                            </div>
                            <div id="cvs-list" class="max-h-40 overflow-y-auto space-y-2 mb-2">
                                <!-- Store List -->
                            </div>
                            <input type="text" id="ship-store-name" placeholder="æˆ–æ‰‹å‹•è¼¸å…¥é–€å¸‚åç¨±"
                                class="w-full bg-white rounded-lg p-2 border border-stone-200">
                        </div>
                    </div>

                    <!-- Home Delivery Address -->
                    <div id="ship-home-info" class="space-y-2 hidden">
                        <div class="flex gap-2">
                            <input type="text" id="ship-zip" placeholder="éƒµéå€è™Ÿ" oninput="handleZipInput(this.value)"
                                class="w-24 bg-stone-50 rounded-xl px-3 py-2 text-base font-bold outline-none">
                            <select id="ship-city" onchange="handleCityChange()"
                                class="flex-1 bg-stone-50 rounded-xl px-3 py-2 text-base font-bold outline-none border border-stone-200">
                                <option value="">ç¸£å¸‚</option>
                            </select>
                            <select id="ship-dist" onchange="handleDistChange()"
                                class="flex-1 bg-stone-50 rounded-xl px-3 py-2 text-base font-bold outline-none border border-stone-200">
                                <option value="">å€åŸŸ</option>
                            </select>
                        </div>
                        <input type="text" id="ship-road" list="road-list" placeholder="è·¯å (å¯é¸)"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-base font-bold outline-none">
                        <datalist id="road-list"></datalist>
                        <input type="text" id="ship-addr-detail" placeholder="é–€ç‰Œè™Ÿç¢¼ã€æ¨“å±¤"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-base font-bold outline-none">
                    </div>

                    <div class="space-y-2">
                        <input type="text" id="chk-name" placeholder="è¨‚è³¼äººå§“å"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-base font-bold outline-none">
                        <input type="tel" id="chk-phone" placeholder="è¯çµ¡é›»è©±" inputmode="numeric"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-base font-bold outline-none">
                    </div>
                </div>

                <div class="flex items-end justify-between mb-4">
                    <div class="text-xs font-bold text-stone-400">
                        <p>å°è¨ˆ $<span id="cart-subtotal">0</span></p>
                        <p>é‹è²» $<span id="cart-shipping">0</span></p>
                    </div>
                    <p class="text-3xl font-black text-orange-600">$<span id="cart-final-total">0</span></p>
                </div>

                <button onclick="submitOrder()" id="btn-checkout"
                    class="w-full bg-stone-900 text-white font-bold py-4 rounded-2xl shadow-xl btn-press">
                    ç¢ºèªçµå¸³
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // CONFIG
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzJb6Noa0JqX6NoOQF8L4EINrryt7P4MdRQN6SC34I_-38LwVpNZSYuMRvn6GP578zO4A/exec';
        const LIFF_ID = '2008678090-SEONUKky';

        // STATE
        let app = {
            view: 'home', // home, store, seller
            user: { id: 'Guest', name: 'Guest', img: '' },
            eventId: new URLSearchParams(window.location.search).get('eventId') || 'default', // Get Event ID
            stores: [], // List of stores for Home
            currentStore: null, // { info, products } for Store View
            cart: [], // { pid, name, price, qty, spec, storeId }
            cartStoreId: null, // Lock cart to this store
            shippingMethod: 'pickup', // pickup, cvs, home

            // Pending Uploads
            storeImgBase64: null,
            prodImgBase64: null
        };

        function fixDriveUrl(url) {
            if (!url || !url.includes('drive.google.com')) return url;
            let match = url.match(/[?&]id=([-\w]{25,})/);
            if (match && match[1]) {
                return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`;
            }
            return url;
        }

        // --- INIT ---
        let TW_ADDRESS_DATA = [];
        let CVS_STORES = [];

        window.onload = async () => {
            await initLIFF();
            initBankSelect();
            initAddressData(); // Load Address JSON
            loadCVSCities(); // Init CVS
            await loadStores(); // Fetch Store List
            loadCartLocal();
            renderHome();
            document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
            // Init Default Ship View - Moved to openCart or goToStore
        };

        // --- ADDRESS LOGIC ---
        async function initAddressData() {
            try {
                const res = await fetch('https://raw.githubusercontent.com/donma/TaiwanAddressCityAreaRoadChineseEnglishJSON/master/AllData.json');
                TW_ADDRESS_DATA = await res.json();

                // Populate City Select
                const citySel = document.getElementById('ship-city');
                citySel.innerHTML = '<option value="">ç¸£å¸‚</option>' + TW_ADDRESS_DATA.map(c => `<option value="${c.CityName}">${c.CityName}</option>`).join('');
            } catch (e) { console.error('Address Load Failed', e); }
        }

        function handleCityChange() {
            const city = document.getElementById('ship-city').value;
            const distSel = document.getElementById('ship-dist');
            const zipInput = document.getElementById('ship-zip');

            distSel.innerHTML = '<option value="">å€åŸŸ</option>';
            zipInput.value = ''; // Reset Zip

            if (!city) return;

            const cityData = TW_ADDRESS_DATA.find(c => c.CityName === city);
            if (cityData) {
                distSel.innerHTML = '<option value="">å€åŸŸ</option>' + cityData.AreaList.map(a => `<option value="${a.AreaName}">${a.AreaName}</option>`).join('');
            }
        }

        function handleDistChange() {
            const city = document.getElementById('ship-city').value;
            const dist = document.getElementById('ship-dist').value;
            const zipInput = document.getElementById('ship-zip');

            if (city && dist) {
                const cityData = TW_ADDRESS_DATA.find(c => c.CityName === city);
                const areaData = cityData ? cityData.AreaList.find(a => a.AreaName === dist) : null;
                if (areaData) {
                    zipInput.value = areaData.ZipCode;
                }
            }
        }

        // Handle Zip Input (Auto-fill)
        function handleZipInput(val) {
            if (val.length < 3) return;
            // Search in Data
            for (const city of TW_ADDRESS_DATA) {
                for (const area of city.AreaList) {
                    if (area.ZipCode === val || area.ZipCode.startsWith(val)) {
                        // Sync UI
                        document.getElementById('ship-city').value = city.CityName;

                        // Trigger District Update Manually to populate options
                        const distSel = document.getElementById('ship-dist');
                        distSel.innerHTML = '<option value="">å€åŸŸ</option>' + city.AreaList.map(a => `<option value="${a.AreaName}">${a.AreaName}</option>`).join('');

                        document.getElementById('ship-dist').value = area.AreaName;

                        // Populate Road Datalist
                        const dl = document.getElementById('road-list');
                        dl.innerHTML = '';
                        if (area.RoadList) {
                            area.RoadList.forEach(r => {
                                const opt = document.createElement('option');
                                opt.value = r.RoadName;
                                dl.appendChild(opt);
                            });
                        }
                        return;
                    }
                }
            }
        }

        // --- CVS LOGIC ---
        async function loadCVSCities() {
            const sel = document.getElementById('cvs-city');
            if (!sel) return; // Prevent Null Error if element not ready
            // Hardcode or get from data? 7-11 JSONs are by City.
            const CITIES = ["åŸºéš†å¸‚", "å°åŒ—å¸‚", "æ–°åŒ—å¸‚", "æ¡ƒåœ’å¸‚", "æ–°ç«¹å¸‚", "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", "å°ä¸­å¸‚", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "å°å—å¸‚", "é«˜é›„å¸‚", "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "å°æ±ç¸£", "æ¾æ¹–ç¸£", "é‡‘é–€ç¸£", "é€£æ±Ÿç¸£"];
            sel.innerHTML = '<option value="">é¸æ“‡ç¸£å¸‚</option>' + CITIES.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        async function loadCVSStores() {
            const brand = document.getElementById('cvs-type').value; // 7-11 or FamilyMart
            const city = document.getElementById('cvs-city').value;
            if (!city) return;

            const list = document.getElementById('cvs-list');
            list.innerHTML = 'è¼‰å…¥ä¸­...';

            // Mapping for URL
            // ctiml repo: 7-11/{City}.json, Familymart/{City}.json
            // Note: Repo uses English or Chinese? Repo uses Chinese filename e.g. "æ–°åŒ—å¸‚.json"
            // Brand Check: "7-11" or "FamilyMart"
            // Fix: Repo uses lowercase "familymart"
            let brandPath = brand === '7-11' ? '7-11' : 'familymart';

            try {
                const url = `https://raw.githubusercontent.com/ctiml/convenience-store-data/master/${brandPath}/${city}.json`;
                const res = await fetch(url);
                const json = await res.json();

                // Fix: Data is in json.stores array
                const rawStores = json.stores || [];

                // Normalize Data: 7-11 uses POIName/Address, Family uses NAME/addr
                CVS_STORES = rawStores.map(s => ({
                    name: s.POIName || s.NAME,
                    address: s.Address || s.addr,
                    // Preserve original for reference if needed
                    _raw: s
                }));

                // Populate Districts
                // Extract districts from address (e.g. "åŸºéš†å¸‚ä»æ„›å€...")
                const dists = [...new Set(CVS_STORES.map(s => {
                    // Simple regex to grab District
                    const m = s.address.match(/(.+?[å¸‚ç¸£])?(.+?[å€é„‰é®å¸‚])/);
                    return m ? m[2] : 'å…¶ä»–';
                }))];

                const distSel = document.getElementById('cvs-dist');
                distSel.innerHTML = '<option value="">å…¨å€åŸŸ</option>' + dists.map(d => `<option value="${d}">${d}</option>`).join('');
                filterCVSStores();

            } catch (e) {
                console.error(e);
                list.innerHTML = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æ‰‹å‹•è¼¸å…¥';
            }
        }

        function filterCVSStores() {
            const dist = document.getElementById('cvs-dist').value;
            const list = document.getElementById('cvs-list');
            list.innerHTML = '';

            const filtered = dist ? CVS_STORES.filter(s => s.address.includes(dist)) : CVS_STORES;

            filtered.forEach(s => {
                const div = document.createElement('div');
                div.className = 'p-2 bg-stone-100 rounded text-xs cursor-pointer hover:bg-orange-100';
                div.innerHTML = `<b>${s.name}</b><br><span class="text-stone-400">${s.address}</span>`;
                div.onclick = () => {
                    document.getElementById('ship-store-name').value = `${s.name} (${s.address})`;
                    // Highlight selection
                };
                list.appendChild(div);
            });
        }

        async function initBankSelect() {
            const sel = document.getElementById('set-bank-code');
            sel.innerHTML = '<option>è¼‰å…¥éŠ€è¡Œåˆ—è¡¨ä¸­...</option>';
            try {
                // Fetch Taiwan Bank List (Open Data / GitHub)
                const res = await fetch('https://raw.githubusercontent.com/nczz/taiwan-banks-list/main/banks_sort_by_codes.json');
                const data = await res.json();

                // Render Options: [Code] Name
                // Some banks share codes (e.g. Farmers Assn), so we list them all.
                sel.innerHTML = '<option value="">é¸æ“‡éŠ€è¡Œ</option>' +
                    data.map(b => `<option value="${b.bank_code} ${b.name}">[${b.bank_code}] ${b.name}</option>`).join('');
            } catch (e) {
                console.error(e);
                sel.innerHTML = '<option value="">éŠ€è¡Œåˆ—è¡¨è¼‰å…¥å¤±æ•—</option>';
            }
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const p = await liff.getProfile();
                    app.user = { id: p.userId, name: p.displayName, img: p.pictureUrl };
                    document.getElementById('user-avatar').src = p.pictureUrl;
                    document.getElementById('user-avatar').classList.remove('hidden');
                } else {
                    liff.login();
                }
            } catch (e) { console.error('LIFF Error', e); }
        }

        async function loadStores() {
            try {
                const res = await fetch(`${GAS_URL}?action=getStores&eventId=${app.eventId}`);
                const json = await res.json();
                app.stores = json.stores || [];
            } catch (e) { alert('è¼‰å…¥å¤±æ•—'); }
        }

        // --- NAVIGATION ---
        function goHome() {
            app.view = 'home';
            app.currentStore = null;
            updateViewUI();
        }

        async function goToStore(storeId) {
            document.getElementById('loading-screen').classList.remove('opacity-0', 'pointer-events-none');
            try {
                // Add timestamp to prevent caching
                const res = await fetch(`${GAS_URL}?action=getStoreData&storeId=${storeId}&eventId=${app.eventId}&_t=${Date.now()}`);
                const json = await res.json();
                app.currentStore = {
                    info: json.store || {},
                    products: json.products || []
                };
                app.view = 'store';
                updateViewUI();
            } catch (e) { alert('é€²å…¥å•†åº—å¤±æ•—'); }
            document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
        }

        function toggleSellerMode() {
            if (app.view === 'seller') {
                goHome(); // Exit
            } else {
                app.view = 'seller';
                updateViewUI();
            }
        }

        function updateViewUI() {
            // Hide all views
            ['view-home', 'view-store', 'view-seller'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('cart-float-btn').classList.add('opacity-0', 'translate-y-20');
            document.getElementById('back-btn').classList.add('hidden');

            const sellerBtn = document.getElementById('seller-btn');

            if (app.view === 'home') {
                document.getElementById('view-home').classList.remove('hidden');
                document.getElementById('page-title').innerHTML = '<span class="text-2xl">ğŸª</span> åœ’éŠæœƒä¸»æœƒå ´';
                sellerBtn.innerHTML = '<span>æˆ‘è¦æ“ºæ”¤</span>';
                sellerBtn.classList.replace('bg-stone-800', 'bg-orange-600');
                renderHome();
            }
            else if (app.view === 'store') {
                document.getElementById('view-store').classList.remove('hidden');
                document.getElementById('back-btn').classList.remove('hidden');

                const info = app.currentStore.info;
                document.getElementById('page-title').innerText = info.Name || 'æ”¤ä½';
                document.getElementById('store-page-name').innerText = info.Name || 'æœªå‘½åæ”¤ä½';
                document.getElementById('store-page-desc').innerText = info.Description || 'æ­¡è¿å…‰è‡¨';
                document.getElementById('store-cover-img').src = info.Image && info.Image.startsWith('http') ? fixDriveUrl(info.Image) : 'https://placehold.co/100';

                // Hide if -1
                const costHome = parseInt(info.Shipping_Home);
                const costStore = parseInt(info.Shipping_Store);

                document.getElementById('store-ship-home').innerText = costHome >= 0 ? `ğŸšš å®…é… $${costHome}` : '';
                document.getElementById('store-ship-home').style.display = costHome >= 0 ? '' : 'none';

                document.getElementById('store-ship-store').innerText = costStore >= 0 ? `ğŸª è¶…å•† $${costStore}` : '';
                document.getElementById('store-ship-store').style.display = costStore >= 0 ? '' : 'none';

                renderProductGrid();
                updateCartUI(); // Show float button if cart has items
            }
            else if (app.view === 'seller') {
                document.getElementById('view-seller').classList.remove('hidden');
                document.getElementById('page-title').innerText = 'æ”¤ä¸»ä¸­å¿ƒ';
                sellerBtn.innerHTML = '<span>å›ä¸»æœƒå ´</span>';
                sellerBtn.classList.replace('bg-orange-600', 'bg-stone-800');

                // Pre-fill User Info if exists in store list
                const myStore = app.stores.find(s => s.StoreID === app.user.id);
                if (myStore) {
                    document.getElementById('set-store-name').value = myStore.Name;
                    document.getElementById('set-store-desc').value = myStore.Description;

                    // Parse Bank Info (Try JSON, fallback to string)
                    try {
                        const bank = JSON.parse(myStore.BankInfo);
                        document.getElementById('set-bank-code').value = bank.code || '';
                        document.getElementById('set-bank-acc').value = bank.acc || '';
                        document.getElementById('set-bank-name').value = bank.name || '';
                    } catch (e) {
                        // Old format or empty
                        document.getElementById('set-bank-acc').value = myStore.BankInfo || '';
                        document.getElementById('set-bank-code').value = '';
                        document.getElementById('set-bank-name').value = '';
                    }

                    document.getElementById('preview-store-img').src = fixDriveUrl(myStore.Image);
                    document.getElementById('preview-store-img').classList.remove('hidden');

                    // Init Shipping Toggles
                    const homePrice = parseInt(myStore.Shipping_Home);
                    initShipToggle('home', isNaN(homePrice) ? 100 : homePrice);

                    const storePrice = parseInt(myStore.Shipping_Store);
                    initShipToggle('store', isNaN(storePrice) ? 60 : storePrice);

                    // Init Pickup Toggle
                    let pkEn = true;
                    try {
                        const bank = JSON.parse(myStore.BankInfo || '{}');
                        // If pickupEnabled key exists, use it. Else default true.
                        if (bank.hasOwnProperty('pickupEnabled')) pkEn = bank.pickupEnabled;

                        // Pickup Info Inputs
                        document.getElementById('set-pickup-loc').value = bank.pickupLoc || '';
                        document.getElementById('set-pickup-tel').value = bank.pickupTel || '';
                    } catch (e) { }

                    document.getElementById('enable-ship-pickup').checked = pkEn;
                    togglePickupInput(); // Sync inputs state

                } else {
                    // New Store - Default to User Profile
                    document.getElementById('set-store-name').value = app.user.name;
                    document.getElementById('preview-store-img').src = fixDriveUrl(app.user.img);
                    document.getElementById('preview-store-img').classList.remove('hidden');
                    document.getElementById('set-bank-code').value = '';
                    document.getElementById('set-bank-acc').value = '';
                    document.getElementById('set-bank-name').value = '';
                    document.getElementById('set-pickup-loc').value = '';
                    document.getElementById('set-pickup-tel').value = '';

                    // Default Defaults
                    initShipToggle('home', 100);
                    initShipToggle('store', 60);

                    document.getElementById('enable-ship-pickup').checked = true;
                    togglePickupInput();
                }

                // Fetch My Products
                fetchMyProducts();
                // Auto Fetch Orders
                fetchSellerOrders();
            }

            window.scrollTo(0, 0);
        }

        // Helper for Toggles
        function initShipToggle(type, price) {
            const chk = document.getElementById(`enable-ship-${type}`);
            const inp = document.getElementById(`set-ship-${type}`);

            if (price >= 0) {
                chk.checked = true;
                inp.value = price;
                inp.disabled = false;
            } else {
                chk.checked = false;
                inp.value = type === 'home' ? 100 : 60; // Default when re-enabled
                inp.disabled = true;
            }
        }

        function toggleShipInput(type) {
            const chk = document.getElementById(`enable-ship-${type}`);
            const inp = document.getElementById(`set-ship-${type}`);
            inp.disabled = !chk.checked;
            if (chk.checked) inp.focus();
        }

        function togglePickupInput() {
            const chk = document.getElementById('enable-ship-pickup');
            const loc = document.getElementById('set-pickup-loc');
            const tel = document.getElementById('set-pickup-tel');
            loc.disabled = !chk.checked;
            tel.disabled = !chk.checked;
        }

        // --- RENDERERS ---
        function renderHome() {
            const container = document.getElementById('store-list');
            if (app.stores.length === 0) {
                container.innerHTML = '<p class="text-center text-stone-400 py-10">ç›®å‰æ²’æœ‰æ”¤ä½ï¼Œå¿«ä¾†æ“ºæ”¤å§ï¼</p>';
                return;
            }
            container.innerHTML = app.stores.map(s => `
                <div onclick="goToStore('${s.StoreID}')" class="bg-white rounded-2xl p-4 shadow-sm flex items-center gap-4 active:scale-95 transition-transform cursor-pointer">
                    <img src="${s.Image && s.Image.startsWith('http') ? fixDriveUrl(s.Image) : 'https://placehold.co/80'}" class="w-16 h-16 rounded-full bg-stone-100 object-cover">
                    <div>
                        <h3 class="font-bold text-lg text-stone-800">${s.Name}</h3>
                        <p class="text-xs text-stone-500 line-clamp-1">${s.Description || 'No description'}</p>
                    </div>
                    <div class="ml-auto text-stone-300">âœ</div>
                </div>
            `).join('');
        }

        function renderProductGrid() {
            const container = document.getElementById('product-grid');
            const products = app.currentStore.products;
            if (products.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center text-stone-400 py-10">æ”¤ä¸»é‚„æ²’æº–å‚™å¥½å•†å“...</div>';
                return;
            }
            container.innerHTML = products.map((p, idx) => `
                <div onclick="openProductModal(${idx})" class="bg-white rounded-2xl p-3 shadow-sm active:scale-95 transition-transform cursor-pointer">
                    <img src="${p.Image && p.Image.startsWith('http') ? fixDriveUrl(p.Image) : 'https://placehold.co/200'}" class="w-full aspect-square rounded-xl object-cover bg-stone-100 mb-2">
                    <h4 class="font-bold text-stone-800 text-sm truncate">${p.Name}</h4>
                    <p class="text-orange-600 font-bold">${p.Price == 0 ? 'å…è²»' : '$' + p.Price}</p>
                </div>
            `).join('');
        }

        // --- CART LOGIC ---
        let currentModalProduct = null;
        let currentModalSpecs = {};

        function openProductModal(idx) {
            const p = app.currentStore.products[idx];
            currentModalProduct = p;
            currentModalSpecs = {};

            document.getElementById('modal-img').src = p.Image && p.Image.startsWith('http') ? fixDriveUrl(p.Image) : 'https://placehold.co/300';
            document.getElementById('modal-name').innerText = p.Name;
            document.getElementById('modal-price').innerText = p.Price == 0 ? 'å…è²»' : `$${p.Price}`;
            document.getElementById('modal-qty').innerText = '1';

            // Render Specs
            const specs = JSON.parse(p.Specs || '{}');
            const container = document.getElementById('modal-specs');
            container.innerHTML = '';
            Object.keys(specs).forEach(key => {
                const vals = specs[key];
                const html = `
                    <div class="space-y-2">
                        <p class="text-xs font-bold text-stone-400">${key}</p>
                        <div class="flex flex-wrap gap-2">
                            ${vals.map((v, i) => `
                                <button onclick="selectSpec('${key}', '${v}')" class="spec-btn spec-${key}-${v} px-3 py-1.5 rounded-lg border border-stone-100 text-xs font-bold ${i === 0 ? 'bg-stone-800 text-white border-stone-800' : 'bg-white text-stone-500'}">
                                    ${v}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
                currentModalSpecs[key] = vals[0]; // Default first
            });

            const modal = document.getElementById('product-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.children[1].classList.remove('translate-y-full'), 10);
        }

        function selectSpec(key, val) {
            currentModalSpecs[key] = val;
            // Update UI
            document.querySelectorAll(`.spec-btn[class*="spec-${key}-"]`).forEach(el => {
                el.classList.remove('bg-stone-800', 'text-white', 'border-stone-800');
                el.classList.add('bg-white', 'text-stone-500');
            });
            const active = document.querySelector(`.spec-${key}-${val}`);
            active.classList.add('bg-stone-800', 'text-white', 'border-stone-800');
            active.classList.remove('bg-white', 'text-stone-500');
        }

        function updateModalQty(d) {
            let q = parseInt(document.getElementById('modal-qty').innerText) + d;
            if (q < 1) q = 1;
            document.getElementById('modal-qty').innerText = q;
        }

        function closeProductModal() {
            const modal = document.getElementById('product-modal');
            modal.children[1].classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function addToCart() {
            // Check Store Lock
            const storeId = app.currentStore.info.StoreID;
            if (app.cartStoreId && app.cartStoreId !== storeId) {
                if (!confirm('æ‚¨çš„è³¼ç‰©è»Šå…§å·²æœ‰å…¶ä»–æ”¤ä½çš„å•†å“ã€‚æ˜¯å¦æ¸…ç©ºè³¼ç‰©è»Šä»¥è³¼è²·æ­¤æ”¤ä½å•†å“ï¼Ÿ')) return;
                app.cart = [];
                app.cartStoreId = null;
            }

            app.cartStoreId = storeId;
            const item = {
                pid: currentModalProduct.ID,
                name: currentModalProduct.Name,
                price: currentModalProduct.Price,
                image: currentModalProduct.Image,
                spec: { ...currentModalSpecs },
                qty: parseInt(document.getElementById('modal-qty').innerText),
                storeId: storeId
            };

            // Check duplicate
            const specStr = JSON.stringify(item.spec);
            const exist = app.cart.find(i => i.pid === item.pid && JSON.stringify(i.spec) === specStr);
            if (exist) exist.qty += item.qty;
            else app.cart.push(item);

            saveCartLocal();
            closeProductModal();
            updateCartUI();

            // Animation
            confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 }, colors: ['#f97316'] });
        }

        // --- CART UI & ACTIONS ---
        function updateCartUI() {
            // Reset float btn
            const btn = document.getElementById('cart-float-btn');
            if (app.cart.length > 0 && app.view === 'store' && app.currentStore.info.StoreID === app.cartStoreId) {
                const count = app.cart.reduce((a, b) => a + b.qty, 0);
                const total = app.cart.reduce((a, b) => a + b.price * b.qty, 0);
                document.getElementById('cart-count').innerText = count;
                document.getElementById('cart-total-float').innerText = `$${total}`;
                btn.classList.remove('opacity-0', 'translate-y-20');
            } else {
                btn.classList.add('opacity-0', 'translate-y-20');
            }
        }

        function openCart() {
            const modal = document.getElementById('cart-modal');
            renderCartItems();
            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('cart-panel').classList.remove('translate-y-full'), 10);

            // Init Method availability
            const info = app.currentStore.info;
            const canHome = parseInt(info.Shipping_Home) >= 0;
            const canStore = parseInt(info.Shipping_Store) >= 0;
            const canPickup = true; // Always true

            document.getElementById('btn-ship-home').style.display = canHome ? '' : 'none';
            document.getElementById('btn-ship-cvs').style.display = canStore ? '' : 'none';
            document.getElementById('btn-ship-pickup').style.display = canPickup ? '' : 'none';

            // Auto switch if current invalid
            if (app.shippingMethod === 'home' && !canHome) app.shippingMethod = 'pickup';
            if (app.shippingMethod === 'cvs' && !canStore) app.shippingMethod = 'pickup';

            setShipMethod(app.shippingMethod || 'pickup');
        }

        function closeCart() {
            document.getElementById('cart-panel').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('cart-modal').classList.add('hidden'), 300);
        }

        function clearCart() {
            app.cart = [];
            app.cartStoreId = null;
            saveCartLocal();
            closeCart();
            updateCartUI();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            if (app.cart.length === 0) { container.innerHTML = '<p class="text-center text-stone-400 py-10">ç©ºç©ºå¦‚ä¹Ÿ</p>'; return; }

            container.innerHTML = app.cart.map((item, idx) => `
                <div class="flex gap-3 bg-white p-3 rounded-2xl shadow-sm border border-stone-50">
                    <img src="${fixDriveUrl(item.image)}" class="w-14 h-14 rounded-lg bg-stone-100 object-cover" onerror="this.src='https://placehold.co/100'">
                    <div class="flex-grow">
                        <h4 class="font-bold text-stone-800">${item.name}</h4>
                        <p class="text-xs text-stone-400">${Object.values(item.spec).join('/')}</p>
                        <p class="text-orange-600 font-bold">${item.price == 0 ? 'å…è²»' : '$' + item.price}</p>
                    </div>
                     <div class="flex items-center gap-2 bg-stone-100 rounded-lg p-1 h-8 self-end">
                        <button onclick="updateCartQty(${idx}, -1)" class="w-6 font-bold text-stone-500">-</button>
                        <span class="text-xs font-bold w-4 text-center">${item.qty}</span>
                        <button onclick="updateCartQty(${idx}, 1)" class="w-6 font-bold text-stone-500">+</button>
                    </div>
                </div>
            `).join('');
            calcTotal();
        }

        function updateCartQty(idx, d) {
            app.cart[idx].qty += d;
            if (app.cart[idx].qty <= 0) app.cart.splice(idx, 1);
            if (app.cart.length === 0) clearCart();
            else {
                saveCartLocal();
                renderCartItems();
                updateCartUI();
            }
        }

        function setShipMethod(m) {
            app.shippingMethod = m;

            // Check availability again (safety)
            const info = app.currentStore.info;
            // ... (Already handled in openCart mostly, but UI Toggle here)

            // Update Buttons
            const activeClass = "flex-1 py-2 rounded-xl border border-stone-800 bg-stone-800 text-white shadow-md transition-all";
            const inactiveClass = "flex-1 py-2 rounded-xl border border-transparent text-stone-400 hover:bg-stone-100 transition-all";

            document.getElementById('btn-ship-pickup').className = m === 'pickup' ? activeClass : inactiveClass;
            document.getElementById('btn-ship-cvs').className = m === 'cvs' ? activeClass : inactiveClass;
            document.getElementById('btn-ship-home').className = m === 'home' ? activeClass : inactiveClass;

            // Toggle Sections
            const pickupInfo = document.getElementById('ship-pickup-info');
            const cvsInfo = document.getElementById('ship-cvs-info');
            const homeInfo = document.getElementById('ship-home-info');

            if (m === 'pickup') {
                pickupInfo.classList.remove('hidden');
                cvsInfo.classList.add('hidden');
                homeInfo.classList.add('hidden');

                // Show Pickup Details
                const info = app.currentStore.info;
                let loc = 'æ”¤ä½ç¾å ´';
                let tel = '';
                try {
                    const bank = JSON.parse(info.BankInfo || '{}');
                    if (bank.pickupLoc) loc = bank.pickupLoc;
                    if (bank.pickupTel) tel = bank.pickupTel;
                } catch (e) { }

                // Update text
                // Check if container exists, if not create/update?
                // Currently pickupInfo only has time input. We should prepend/append info.

                // Reset content
                pickupInfo.innerHTML = `
                    <p class="text-xs font-bold text-stone-500 mb-2">è«‹é¸æ“‡å–è²¨æ™‚é–“</p>
                    <input type="datetime-local" id="pickup-time" 
                        class="w-full bg-stone-50 rounded-xl px-3 py-2 text-base font-bold outline-none mb-2">
                    <div class="bg-orange-50 p-3 rounded-xl border border-orange-100 text-xs space-y-1">
                        <p class="font-bold text-stone-700">ğŸ“ å–è²¨åœ°é»ï¼š${loc}</p>
                        ${tel ? `<p class="font-bold text-stone-700">ğŸ“ æ”¤ä¸»é›»è©±ï¼š${tel}</p>` : ''}
                    </div>
                `;

            } else if (m === 'cvs') {
                pickupInfo.classList.add('hidden');
                cvsInfo.classList.remove('hidden');
                homeInfo.classList.add('hidden');
            } else { // home
                pickupInfo.classList.add('hidden');
                cvsInfo.classList.add('hidden');
                homeInfo.classList.remove('hidden');
            }

            calcTotal();
        }

        function calcTotal() {
            const subtotal = app.cart.reduce((a, b) => a + b.price * b.qty, 0);
            let shipFee = 0;

            if (app.shippingMethod === 'home') {
                shipFee = parseInt(app.currentStore.info.Shipping_Home || 100);
            } else if (app.shippingMethod === 'cvs') {
                shipFee = parseInt(app.currentStore.info.Shipping_Store || 60);
            } else {
                // pickup = 0
                shipFee = 0;
            }

            document.getElementById('cart-subtotal').innerText = subtotal;
            document.getElementById('cart-shipping').innerText = shipFee;
            document.getElementById('cart-final-total').innerText = subtotal + shipFee;
        }

        async function submitOrder() {
            const name = document.getElementById('chk-name').value;
            const phone = document.getElementById('chk-phone').value;

            let addr = '';

            // Validation per method
            if (app.shippingMethod === 'pickup') {
                const time = document.getElementById('pickup-time').value;
                if (!time) return alert('è«‹é¸æ“‡é ç´„è‡ªå–æ™‚é–“');
                addr = `[è‡ªå–é ç´„] ${time.replace('T', ' ')}`;
            }
            else if (app.shippingMethod === 'cvs') {
                addr = document.getElementById('ship-store-name').value;
                if (!addr) return alert('è«‹é¸æ“‡æˆ–è¼¸å…¥å–è²¨é–€å¸‚');
            }
            else { // home
                const city = document.getElementById('ship-city').value;
                const dist = document.getElementById('ship-dist').value;
                const road = document.getElementById('ship-road').value;
                const detail = document.getElementById('ship-addr-detail').value;
                if (!city || !dist || !detail) return alert('è«‹å¡«å¯«å®Œæ•´æ”¶ä»¶åœ°å€');
                addr = `${document.getElementById('ship-zip').value} ${city}${dist}${road}${detail}`;
            }

            if (!name || !phone) return alert('è«‹å¡«å¯«å§“åèˆ‡é›»è©±');

            const btn = document.getElementById('btn-checkout');
            btn.innerHTML = 'è™•ç†ä¸­...';
            btn.disabled = true;

            const subtotal = app.cart.reduce((a, b) => a + b.price * b.qty, 0);
            let shipFee = 0;
            if (app.shippingMethod === 'home') shipFee = parseInt(app.currentStore.info.Shipping_Home || 100);
            if (app.shippingMethod === 'cvs') shipFee = parseInt(app.currentStore.info.Shipping_Store || 60);

            const payload = {
                action: 'submitOrder',
                eventId: app.eventId,
                data: {
                    eventId: app.eventId,
                    storeId: app.cartStoreId,
                    memberId: app.user.id,
                    memberName: app.user.name,
                    recipientName: name,
                    recipientPhone: phone,
                    method: app.shippingMethod,
                    address: addr,
                    items: app.cart,
                    total: subtotal + shipFee
                }
            };

            try {
                const res = await fetch(`${GAS_URL}?eventId=${app.eventId}`, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === 'success') {
                    alert('ğŸ‰ è¨‚å–®å·²é€å‡ºï¼');
                    clearCart();
                } else alert('Error: ' + json.message);
            } catch (e) { alert('é€£ç·šå¤±æ•—'); }

            btn.innerHTML = 'ç¢ºèªçµå¸³';
            btn.disabled = false;
        }

        // --- SELLER API ---
        function handleStoreImage(inp) { handleImage(inp, 'preview-store-img', (b64) => app.storeImgBase64 = b64); }
        function handleProdImage(inp) { handleImage(inp, 'preview-prod-img', (b64) => app.prodImgBase64 = b64); }

        function handleImage(inp, previewId, callback) {
            if (inp.files && inp.files[0]) {
                const file = inp.files[0];
                // Compress Image (Max 800px, 0.7 quality)
                compressImage(file, 800, 0.7).then(b64 => {
                    document.getElementById(previewId).src = b64;
                    document.getElementById(previewId).classList.remove('hidden');
                    callback(b64);
                });
            }
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
                        if (h > maxWidth) { w = Math.round(w * (maxWidth / h)); h = maxWidth; } // Also check height

                        const canvas = document.createElement('canvas');
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
            });
        }

        // Save Store Settings
        async function saveStoreSettings() {
            if (app.user.id === 'Guest') return alert('è«‹å…ˆç™»å…¥ LINE (æ¸¬è©¦ç’°å¢ƒä¸å¯ç”¨)');

            const btn = document.getElementById('btn-save-store');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'å„²å­˜ä¸­...'; btn.disabled = true;

            // Collect Bank Info & Pickup Info
            const pickupEnabled = document.getElementById('enable-ship-pickup').checked;
            const bankData = {
                code: document.getElementById('set-bank-code').value,
                acc: document.getElementById('set-bank-acc').value,
                name: document.getElementById('set-bank-name').value,
                pickupEnabled: pickupEnabled, // Save Boolean
                pickupLoc: document.getElementById('set-pickup-loc').value,
                pickupTel: document.getElementById('set-pickup-tel').value
            };

            // Logic: If checkbox unchecked, value is -1
            const shipHomeEnabled = document.getElementById('enable-ship-home').checked;
            const shipStoreEnabled = document.getElementById('enable-ship-store').checked;

            const payload = {
                action: 'updateStore',
                eventId: app.eventId,
                data: {
                    eventId: app.eventId,
                    storeId: app.user.id,
                    name: document.getElementById('set-store-name').value,
                    desc: document.getElementById('set-store-desc').value,
                    bankInfo: JSON.stringify(bankData),
                    shipHome: shipHomeEnabled ? parseInt(document.getElementById('set-ship-home').value || 0) : -1,
                    shipStore: shipStoreEnabled ? parseInt(document.getElementById('set-ship-store').value || 0) : -1,
                    imageBase64: app.storeImgBase64,
                    imageUrl: app.storeImgBase64 ? '' : document.getElementById('preview-store-img').src
                }
            };

            // Send
            try {
                // console.log('Sending Payload:', payload);
                const res = await fetch(`${GAS_URL}?eventId=${app.eventId}`, { method: 'POST', body: JSON.stringify(payload) });
                // Check content type
                const text = await res.text();
                try {
                    const json = JSON.parse(text);
                    if (json.result === 'success') alert('âœ… å•†åº—è¨­å®šå·²æ›´æ–°');
                    else alert('æ›´æ–°å¤±æ•—: ' + (json.message || 'æœªçŸ¥éŒ¯èª¤'));
                } catch (e) {
                    console.error('Response Parse Error:', text);
                    alert('ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤ (å¯èƒ½æ˜¯æª”æ¡ˆå¤ªå¤§ç²é€¾æ™‚)');
                }
            } catch (e) {
                console.error(e);
                alert('é€£ç·šå¤±æ•—: ' + e.message);
            }

            btn.innerHTML = originalText; btn.disabled = false;
        }

        // Create Product
        async function submitProduct() {
            if (!app.prodImgBase64 && app.editingProductIdx === null) return alert('è«‹ä¸Šå‚³å•†å“ç…§');
            const price = parseFloat(document.getElementById('prod-price').value);
            if (price < 0) return alert('å•†å“åƒ¹æ ¼ä¸èƒ½ç‚ºè² æ•¸');

            const btn = document.getElementById('submit-prod-btn');
            btn.innerHTML = 'ä¸Šæ¶ä¸­...'; btn.disabled = true;

            // Collect Specs (Simplified)
            const specs = {};
            document.querySelectorAll('#specs-container > div').forEach(div => {
                const k = div.querySelector('.spec-key').value;
                const v = div.querySelector('.spec-vals').value;
                if (k) specs[k] = v.split(',');
            });

            const payload = {
                action: app.editingProductIdx !== null ? 'updateProduct' : 'createProduct',
                eventId: app.eventId,
                data: {
                    eventId: app.eventId,
                    sellerId: app.user.id,
                    sellerName: app.user.name,
                    // If creating, id is null (backend generates). If updating, pass ID.
                    id: app.editingProductIdx !== null ? (app.myProducts[app.editingProductIdx].ID || app.myProducts[app.editingProductIdx].id) : null,
                    // backend_v4.5 expects 'id' for update.
                    // It uses Date.now() for PID on create.
                    name: document.getElementById('prod-name').value,
                    price: document.getElementById('prod-price').value,
                    category: document.getElementById('prod-cat').value,
                    specs: specs,
                    imageBase64: app.prodImgBase64,
                    imageUrl: app.editingProductIdx !== null && !app.prodImgBase64 ? document.getElementById('preview-prod-img').src : null
                }
            };

            try {
                const res = await fetch(`${GAS_URL}?eventId=${app.eventId}`, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === 'success') {
                    alert(app.editingProductIdx !== null ? 'âœ… ä¿®æ”¹æˆåŠŸ' : 'âœ… ä¸Šæ¶æˆåŠŸ');
                    document.getElementById('sell-form').reset();
                    app.prodImgBase64 = null;
                    document.getElementById('preview-prod-img').classList.add('hidden');
                    cancelEdit(); // Reset Mode
                    fetchMyProducts(); // Refresh List
                } else alert('æ“ä½œå¤±æ•—: ' + json.message);
            } catch (e) { alert('Error'); }

            btn.innerHTML = 'ç¢ºèªä¸Šæ¶'; btn.disabled = false;
        }

        // --- PRODUCT EDIT LOGIC ---
        app.myProducts = [];
        app.editingProductIdx = null;

        async function fetchMyProducts() {
            try {
                // Add timestamp to prevent caching
                const res = await fetch(`${GAS_URL}?action=getStoreData&storeId=${app.user.id}&eventId=${app.eventId}&_t=${Date.now()}`);
                const json = await res.json();
                console.log('My Products:', json); // Debug
                app.myProducts = json.products || [];
                renderSellerProducts();
            } catch (e) { console.error('Fetch My Products Error', e); }
        }

        function renderSellerProducts() {
            const container = document.getElementById('seller-product-list');
            if (app.myProducts.length === 0) {
                container.innerHTML = '<p class="text-center text-stone-400 text-xs py-4">æ‚¨é‚„æ²’æœ‰ä¸Šæ¶ä»»ä½•å•†å“</p>';
                return;
            }
            container.innerHTML = app.myProducts.map((p, i) => `
                <div class="flex items-center gap-3 bg-stone-50 p-3 rounded-xl">
                    <img src="${p.Image && p.Image.startsWith('http') ? fixDriveUrl(p.Image) : 'https://placehold.co/80'}" class="w-12 h-12 rounded-lg object-cover bg-stone-200">
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-sm text-stone-800 truncate">${p.Name}</h4>
                        <p class="text-orange-600 font-bold text-xs">${p.Price == 0 ? 'å…è²»' : '$' + p.Price}</p>
                    </div>
                    <button onclick="editProduct(${i})" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold">ç·¨è¼¯</button>
                    <button onclick="deleteProduct(${i})" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold">åˆªé™¤</button>
                </div>
            `).join('');
        }


        async function deleteProduct(idx) {
            const p = app.myProducts[idx];
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å•†å“ã€Œ${p.Name}ã€å—ï¼Ÿ`)) return;

            const payload = {
                action: 'deleteProduct',
                eventId: app.eventId,
                data: {
                    eventId: app.eventId,
                    id: p.ID || p.id
                }
            };

            try {
                const res = await fetch(`${GAS_URL}?eventId=${app.eventId}`, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === 'success') {
                    alert('âœ… å•†å“å·²åˆªé™¤');
                    fetchMyProducts(); // Refresh list
                } else alert('åˆªé™¤å¤±æ•—: ' + json.message);
            } catch (e) { alert('é€£ç·šå¤±æ•—'); }
        }

        function editProduct(idx) {
            const p = app.myProducts[idx];
            app.editingProductIdx = idx;

            // Fill Form
            document.getElementById('prod-name').value = p.Name;
            document.getElementById('prod-price').value = p.Price;
            document.getElementById('prod-cat').value = p.Category || '';

            // Image
            document.getElementById('preview-prod-img').src = fixDriveUrl(p.Image);
            document.getElementById('preview-prod-img').classList.remove('hidden');
            app.prodImgBase64 = null; // Don't change unless new upload

            // Specs
            const specs = JSON.parse(p.Specs || '{}');
            const container = document.getElementById('specs-container');
            container.innerHTML = '';
            Object.keys(specs).forEach(k => {
                const d = document.createElement('div');
                d.className = "flex gap-2";
                d.innerHTML = `<input class="spec-key w-1/3 p-2 rounded text-xs" value="${k}"><input class="spec-vals flex-1 p-2 rounded text-xs" value="${specs[k].join(',')}">`;
                container.appendChild(d);
            });
            if (Object.keys(specs).length === 0) addSpecLine(); // Default empty line

            // Change UI
            document.getElementById('submit-prod-btn').innerHTML = 'ç¢ºèªä¿®æ”¹';
            document.getElementById('submit-prod-btn').classList.replace('bg-orange-500', 'bg-blue-600');

            // Add Cancel Button if not exists
            if (!document.getElementById('btn-cancel-edit')) {
                const btn = document.createElement('button');
                btn.id = 'btn-cancel-edit';
                btn.type = 'button';
                btn.className = 'w-full bg-stone-200 text-stone-500 font-bold py-3 rounded-xl mt-2';
                btn.innerText = 'å–æ¶ˆä¿®æ”¹';
                btn.onclick = cancelEdit;
                document.getElementById('sell-form').appendChild(btn);
            }

            // Scroll to form
            document.getElementById('sell-form').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            app.editingProductIdx = null;
            document.getElementById('sell-form').reset();
            document.getElementById('preview-prod-img').classList.add('hidden');
            app.prodImgBase64 = null;
            document.getElementById('specs-container').innerHTML = '';
            addSpecLine();

            document.getElementById('submit-prod-btn').innerHTML = 'ç¢ºèªä¸Šæ¶';
            document.getElementById('submit-prod-btn').classList.replace('bg-blue-600', 'bg-orange-500');

            const cancelBtn = document.getElementById('btn-cancel-edit');
            if (cancelBtn) cancelBtn.remove();
        }

        function addSpecLine() {
            const d = document.createElement('div');
            d.className = "flex gap-2";
            d.innerHTML = '<input class="spec-key w-1/3 p-2 rounded text-xs" placeholder="è¦æ ¼å"><input class="spec-vals flex-1 p-2 rounded text-xs" placeholder="é¸é …1,é¸é …2">';
            document.getElementById('specs-container').appendChild(d);
        }

        // --- SELLER ORDERS & PRINT ---
        app.sellerOrders = [];

        async function fetchSellerOrders() {
            const list = document.getElementById('seller-order-list');
            list.innerHTML = '<p class="text-center text-stone-400 text-xs py-4">è®€å–ä¸­...</p>';

            try {
                const res = await fetch(`${GAS_URL}?action=getOrders&storeId=${app.user.id}&eventId=${app.eventId}&_t=${Date.now()}`);
                const json = await res.json();
                app.sellerOrders = json.orders || [];
                renderSellerOrders();
            } catch (e) {
                console.error(e);
                list.innerHTML = '<p class="text-center text-red-500 text-xs py-4">è®€å–å¤±æ•—</p>';
            }
        }

        function renderSellerOrders() {
            const list = document.getElementById('seller-order-list');
            if (app.sellerOrders.length === 0) {
                list.innerHTML = '<p class="text-center text-stone-400 text-xs py-4">ç›®å‰æ²’æœ‰è¨‚å–®</p>';
                return;
            }
            list.innerHTML = app.sellerOrders.map((o, i) => `
                <div onclick="viewOrder(${i})" class="bg-stone-50 p-3 rounded-xl flex justify-between items-center cursor-pointer active:bg-stone-100">
                    <div>
                        <p class="font-bold text-sm text-stone-800">${o.recipientName || 'é¡§å®¢'} <span class="text-xs font-normal text-stone-400">(${o.time.split(' ')[1] || o.time})</span></p>
                        <p class="text-xs text-stone-500">ç¸½è¨ˆ $${o.total}</p>
                    </div>
                    <div class="text-stone-300">âœ</div>
                </div>
            `).join('');
        }

        function viewOrder(idx) {
            const o = app.sellerOrders[idx];
            const modal = document.getElementById('order-modal');
            const content = document.getElementById('receipt-node');

            // Build Receipt HTML
            content.innerHTML = `
                <div class="text-center border-b-2 border-stone-800 pb-4 mb-4">
                    <h2 class="text-2xl font-black">${app.user.name} (å‡ºè²¨å–®)</h2>
                    <p class="text-xs mt-1">å–®è™Ÿ: ${o.id}</p>
                    <p class="text-xs">æ™‚é–“: ${o.time}</p>
                </div>
                <div class="space-y-1 mb-4 text-sm">
                    <p><b>é¡§å®¢:</b> ${o.recipientName} / ${o.recipientPhone}</p>
                    <p><b>æ–¹å¼:</b> ${getShipMethodName(o.method)}</p>
                    <p class="text-xs text-stone-500 break-words">${o.address}</p>
                </div>
                <table class="w-full text-sm mb-4">
                    <thead>
                        <tr class="border-b border-stone-300 text-left">
                            <th class="py-1">å“é …</th>
                            <th class="py-1 w-8 text-center">é‡</th>
                            <th class="py-1 w-12 text-right">å°è¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-stone-100">
                        ${o.items.map(item => `
                            <tr>
                                <td class="py-2">
                                    <div class="font-bold">${item.name}</div>
                                    <div class="text-xs text-stone-400">${Object.values(item.spec || {}).join('/')}</div>
                                </td>
                                <td class="py-2 text-center font-bold">${item.qty}</td>
                                <td class="py-2 text-right">$${item.price * item.qty}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="border-t-2 border-stone-800 pt-2 flex justify-between items-center font-black text-xl">
                    <span>ç¸½é‡‘é¡</span>
                    <span>$${o.total}</span>
                </div>
                <div class="mt-4 text-[10px] text-center text-stone-400">
                    Garden Party Order System
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function getShipMethodName(m) {
            if (m === 'home') return 'å®…é…åˆ°åºœ';
            if (m === 'cvs') return 'è¶…å•†å–è²¨';
            if (m === 'pickup') return 'æ”¤ä½è‡ªå–';
            return m;
        }

        function closeOrderModal() {
            document.getElementById('order-modal').classList.add('hidden');
        }

        function printOrderImage() {
            const node = document.getElementById('receipt-node');

            // Temporarily disable scaling for better capture? 
            // html2canvas works best if element is visible.

            html2canvas(node, {
                scale: 2, // Retinas support
                backgroundColor: "#ffffff",
                logging: false,
                useCORS: true // Attempt to load remote images if any
            }).then(canvas => {
                const imgData = canvas.toDataURL("image/jpeg", 0.9);
                document.getElementById('generated-receipt-img').src = imgData;
                document.getElementById('img-modal').classList.remove('hidden');
            });
        }

        // --- STORAGE ---
        function saveCartLocal() {
            localStorage.setItem('cart', JSON.stringify(app.cart));
            localStorage.setItem('cartStoreId', app.cartStoreId || '');
        }
        function loadCartLocal() {
            const c = localStorage.getItem('cart');
            if (c) app.cart = JSON.parse(c);
            app.cartStoreId = localStorage.getItem('cartStoreId');
        }

    </script>
</body>

</html>
