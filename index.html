<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ordering Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .btn-press:active {
            transform: scale(0.96);
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-stone-50 text-stone-800 pb-20 selection:bg-orange-100">

    <!-- Loading Screen -->
    <div id="loading-screen"
        class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-stone-200 border-t-orange-500 mb-4"></div>
        <p class="text-stone-400 font-bold tracking-widest text-xs">LOADING</p>
    </div>

    <!-- Header (Sticky) -->
    <header
        class="fixed top-0 left-0 right-0 z-40 glass border-b border-stone-100 shadow-sm transition-all duration-300"
        id="header">
        <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <!-- Back Button (Hidden on Home) -->
                <button id="back-btn" onclick="goHome()"
                    class="hidden p-2 -ml-2 rounded-full hover:bg-stone-100 transition-colors">
                    <svg class="w-5 h-5 text-stone-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <!-- Title / Store Name -->
                <h1 id="page-title" class="font-black text-xl text-stone-800 tracking-tight flex items-center gap-2">
                    <span class="text-2xl">ğŸ›ï¸</span> å¸‚é›†å¤§å»³
                </h1>
            </div>

            <div class="flex items-center gap-2">
                <!-- Mode Toggle (Seller) -->
                <button onclick="toggleSellerMode()" id="seller-btn"
                    class="bg-stone-800 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-sm active:scale-95 flex items-center gap-1">
                    <span>æˆ‘è¦é–‹åº—</span>
                </button>
                <!-- User Avatar -->
                <img id="user-avatar" src=""
                    class="w-8 h-8 rounded-full bg-stone-200 object-cover border border-stone-100 hidden">
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="max-w-md mx-auto pt-20 px-4 min-h-screen relative">

        <!-- VIEW: Platform Home (Store List) -->
        <main id="view-home" class="animate-fade-in space-y-6">
            <div class="space-y-1 px-1">
                <h2 class="text-2xl font-black text-stone-800">æ¢ç´¢å¥½åº—</h2>
                <p class="text-xs text-stone-500 font-bold">ä»Šå¤©æƒ³è²·é»ä»€éº¼ï¼Ÿ</p>
            </div>
            <!-- Store Grid -->
            <div id="store-list" class="grid grid-cols-1 gap-4 pb-10">
                <!-- Skeloton -->
                <div class="bg-white rounded-2xl p-4 shadow-sm h-32 animate-pulse bg-stone-200"></div>
            </div>
        </main>

        <!-- VIEW: Store Page (Products) -->
        <main id="view-store" class="hidden animate-fade-in space-y-6 pb-24">
            <!-- Store Cover Info -->
            <div id="store-header"
                class="bg-white rounded-3xl p-6 shadow-sm border border-stone-100 text-center space-y-2 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-orange-50 to-white -z-10"></div>
                <img id="store-cover-img" src=""
                    class="w-20 h-20 rounded-full mx-auto object-cover bg-stone-200 shadow-md mb-2">
                <h2 id="store-page-name" class="text-2xl font-black text-stone-800">Store Name</h2>
                <p id="store-page-desc" class="text-sm text-stone-500 font-bold">Store Description</p>
                <div class="flex justify-center gap-4 text-xs font-bold text-stone-400 pt-2">
                    <span id="store-ship-home">ğŸšš å®…é… $100</span>
                    <span id="store-ship-store">ğŸª è¶…å•† $60</span>
                </div>
            </div>

            <!-- Product Grid -->
            <div id="product-grid" class="grid grid-cols-2 gap-4">
                <!-- Products rendered here -->
            </div>
        </main>

        <!-- VIEW: Seller Dashboard -->
        <main id="view-seller" class="hidden animate-fade-in space-y-8 pb-24">
            <div class="space-y-1">
                <h2 class="text-2xl font-black text-stone-800">è³£å®¶ä¸­å¿ƒ</h2>
                <p class="text-xs text-stone-500 font-bold">ç®¡ç†æ‚¨çš„å•†åº—èˆ‡å•†å“</p>
            </div>

            <!-- 1. Store Settings Module -->
            <section class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 space-y-4">
                <h3 class="font-bold text-lg flex items-center gap-2">ğŸª å•†åº—è¨­å®š</h3>

                <div class="grid grid-cols-[auto_1fr] gap-4 items-center">
                    <div class="relative w-16 h-16 rounded-full bg-stone-100 overflow-hidden group cursor-pointer border-2 border-dashed border-stone-300 hover:border-orange-500 transition-colors"
                        onclick="document.getElementById('store-img-input').click()">
                        <img id="preview-store-img" class="w-full h-full object-cover hidden">
                        <div
                            class="absolute inset-0 flex items-center justify-center text-stone-400 group-hover:text-orange-500">
                            ğŸ“·</div>
                    </div>
                    <input type="file" id="store-img-input" accept="image/*" class="hidden"
                        onchange="handleStoreImage(this)">
                    <div class="space-y-2">
                        <input type="text" id="set-store-name" placeholder="å•†åº—åç¨±"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-sm font-bold outline-none border border-transparent focus:border-stone-300">
                        <input type="text" id="set-store-desc" placeholder="å•†åº—ç°¡ä»‹ (ä¸€å¥è©±)"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-xs font-bold outline-none border border-transparent focus:border-stone-300">
                    </div>
                </div>

                <div class="space-y-2 pt-2 border-t border-stone-100">
                    <label class="text-xs font-bold text-stone-400">åŒ¯æ¬¾è³‡è¨Š (éŠ€è¡Œä»£ç¢¼/å¸³è™Ÿ)</label>
                    <textarea id="set-bank-info" rows="2"
                        class="w-full bg-stone-50 rounded-xl p-3 text-xs font-bold outline-none resize-none"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-stone-400 block mb-1">å®…é…é‹è²»</label>
                        <input type="number" id="set-ship-home" value="100"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-sm font-bold outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-stone-400 block mb-1">è¶…å•†é‹è²»</label>
                        <input type="number" id="set-ship-store" value="60"
                            class="w-full bg-stone-50 rounded-xl px-3 py-2 text-sm font-bold outline-none">
                    </div>
                </div>

                <button onclick="saveStoreSettings()" id="btn-save-store"
                    class="w-full bg-stone-800 text-white font-bold py-3 rounded-xl text-sm btn-press">å„²å­˜å•†åº—è¨­å®š</button>
            </section>

            <!-- 2. Create Product Module -->
            <section class="bg-white p-5 rounded-3xl shadow-sm border border-stone-100 space-y-4">
                <h3 class="font-bold text-lg flex items-center gap-2">ğŸ“¦ ä¸Šæ¶æ–°å•†å“</h3>
                <form id="sell-form" class="space-y-4" onsubmit="event.preventDefault(); submitProduct();">
                    <!-- Image Upload -->
                    <div class="relative w-full aspect-video bg-stone-50 rounded-xl border-2 border-dashed border-stone-200 flex flex-col items-center justify-center cursor-pointer hover:border-orange-400 transition-colors overflow-hidden group"
                        onclick="document.getElementById('prod-img-input').click()">
                        <img id="preview-prod-img" class="absolute inset-0 w-full h-full object-cover hidden">
                        <div class="text-center group-hover:scale-110 transition-transform">
                            <span class="text-2xl">ğŸ“¸</span>
                            <p class="text-[10px] font-bold text-stone-400 mt-1">ä¸Šå‚³å•†å“ç…§</p>
                        </div>
                    </div>
                    <input type="file" id="prod-img-input" accept="image/*" class="hidden"
                        onchange="handleProdImage(this)">

                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="prod-name" required placeholder="å•†å“åç¨±"
                            class="col-span-2 w-full bg-stone-50 rounded-xl px-4 py-3 text-sm font-bold outline-none">
                        <input type="number" id="prod-price" required placeholder="åƒ¹æ ¼"
                            class="w-full bg-stone-50 rounded-xl px-4 py-3 text-sm font-bold outline-none">
                        <input type="text" id="prod-cat" required placeholder="åˆ†é¡" list="cat-list"
                            class="w-full bg-stone-50 rounded-xl px-4 py-3 text-sm font-bold outline-none">
                    </div>

                    <!-- Specs -->
                    <div class="bg-stone-50 p-3 rounded-xl space-y-2">
                        <div class="flex justify-between items-center"><span class="text-xs font-bold text-stone-400">è¦æ ¼
                                (é¸å¡«)</span> <button type="button" onclick="addSpecLine()"
                                class="text-orange-500 text-xs font-bold">+å¢åŠ </button></div>
                        <div id="specs-container" class="space-y-2">
                            <div class="flex gap-2"><input class="spec-key w-1/3 p-2 rounded text-xs" placeholder="é¡è‰²"
                                    value="æ¨£å¼"><input class="spec-vals flex-1 p-2 rounded text-xs" placeholder="ç´…,è—">
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="submit-prod-btn"
                        class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-200 btn-press">ç¢ºèªä¸Šæ¶</button>
                </form>
            </section>
        </main>

    </div>

    <!-- Floating Cart Button (Visible in Store View) -->
    <div id="cart-float-btn"
        class="fixed bottom-6 left-0 right-0 z-30 pointer-events-none opacity-0 translate-y-20 transition-all duration-300">
        <div class="max-w-md mx-auto px-6 flex justify-center">
            <button onclick="openCart()"
                class="pointer-events-auto bg-stone-900 text-white rounded-full px-6 py-3 shadow-2xl flex items-center gap-3 active:scale-95 transition-transform">
                <div class="relative">
                    <span class="text-xl">ğŸ›’</span>
                    <span id="cart-count"
                        class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-stone-900">0</span>
                </div>
                <span class="font-bold pr-1">çµå¸³å»</span>
                <span id="cart-total-float" class="font-mono text-orange-300 pl-2 border-l border-stone-700">$0</span>
            </button>
        </div>
    </div>

    <!-- MODALS (Product, Cart) - Reuse logical structure -->
    <!-- (Simplified for brevity, ensuring critical logic is present) -->

    <!-- Product Detail Modal -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeProductModal()"></div>
        <div
            class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 transition-transform duration-300 translate-y-full transform max-h-[85vh] overflow-y-auto">
            <div class="w-12 h-1.5 bg-stone-200 rounded-full mx-auto mb-6"></div>
            <img id="modal-img" class="w-full aspect-square object-cover rounded-2xl mb-4 bg-stone-100">
            <div class="space-y-4">
                <div>
                    <h3 id="modal-name" class="text-2xl font-black text-stone-800">Product</h3>
                    <p id="modal-price" class="text-xl font-bold text-orange-600">$0</p>
                </div>
                <!-- Specs -->
                <div id="modal-specs" class="space-y-3"></div>
                <!-- Qty -->
                <div class="flex items-center justify-between bg-stone-50 p-3 rounded-xl">
                    <span class="text-sm font-bold text-stone-500">æ•¸é‡</span>
                    <div class="flex items-center gap-4">
                        <button onclick="updateModalQty(-1)"
                            class="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center font-bold text-lg">-</button>
                        <span id="modal-qty" class="font-bold text-xl px-2">1</span>
                        <button onclick="updateModalQty(1)"
                            class="w-8 h-8 rounded-full bg-white shadow flex items-center justify-center font-bold text-lg">+</button>
                    </div>
                </div>
                <button onclick="addToCart()"
                    class="w-full bg-stone-900 text-white font-bold py-4 rounded-2xl shadow-lg btn-press">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeCart()"></div>
        <div id="cart-panel"
            class="absolute bottom-0 left-0 right-0 bg-stone-50 h-[85vh] rounded-t-3xl flex flex-col transition-transform duration-300 translate-y-full shadow-2xl">
            <!-- Header -->
            <div
                class="bg-white px-6 py-4 rounded-t-3xl border-b border-stone-100 flex justify-between items-center flex-shrink-0">
                <h3 class="font-black text-xl text-stone-800">è³¼ç‰©è»Š</h3>
                <button onclick="clearCart()"
                    class="text-xs font-bold text-red-500 bg-red-50 px-3 py-1.5 rounded-full">æ¸…ç©º</button>
            </div>
            <!-- Items -->
            <div id="cart-items-container" class="flex-grow overflow-y-auto p-4 space-y-3">
                <!-- Items Rendered Here -->
            </div>
            <!-- Checkout Footer -->
            <div class="bg-white p-6 border-t border-stone-100 flex-shrink-0 safe-pb">
                <!-- Checkout Forms (Condensed) -->
                <div class="space-y-3 mb-4">
                    <p class="text-xs font-bold text-stone-400">æ”¶ä»¶è³‡è¨Š</p>
                    <div class="grid grid-cols-2 gap-2">
                        <input id="chk-name" placeholder="å§“å" class="bg-stone-50 p-3 rounded-xl text-sm font-bold">
                        <input id="chk-phone" placeholder="é›»è©±" class="bg-stone-50 p-3 rounded-xl text-sm font-bold">
                    </div>
                    <!-- Shipping Method Tabs -->
                    <div class="flex gap-2 text-xs font-bold">
                        <button onclick="setShipMethod('store')" id="btn-ship-store"
                            class="flex-1 py-2 rounded-lg border border-stone-800 bg-stone-800 text-white">è¶…å•†å–è²¨</button>
                        <button onclick="setShipMethod('home')" id="btn-ship-home"
                            class="flex-1 py-2 rounded-lg border border-stone-200 text-stone-400">å®…é…</button>
                    </div>
                    <input id="chk-addr" placeholder="é–€å¸‚åç¨± / å®…é…åœ°å€"
                        class="w-full bg-stone-50 p-3 rounded-xl text-sm font-bold">
                </div>

                <div class="flex items-end justify-between mb-4">
                    <div class="text-xs font-bold text-stone-400">
                        <p>å°è¨ˆ $<span id="cart-subtotal">0</span></p>
                        <p>é‹è²» $<span id="cart-shipping">0</span></p>
                    </div>
                    <p class="text-3xl font-black text-orange-600">$<span id="cart-final-total">0</span></p>
                </div>

                <button onclick="submitOrder()" id="btn-checkout"
                    class="w-full bg-stone-900 text-white font-bold py-4 rounded-2xl shadow-xl btn-press">
                    ç¢ºèªçµå¸³
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // CONFIG
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby0eaLjowGyKy5DDWgGT0mfDIod8zEXgy4-hdeYW4pPoQ_OaWu8K1KPh8V-V0o-ZeA/exec';
        const LIFF_ID = '2008678090-SEONUKky';

        // STATE
        let app = {
            view: 'home', // home, store, seller
            user: { id: 'Guest', name: 'Guest', img: '' },
            stores: [], // List of stores for Home
            currentStore: null, // { info, products } for Store View
            cart: [], // { pid, name, price, qty, spec, storeId }
            cartStoreId: null, // Lock cart to this store
            shippingMethod: 'store', // store, home

            // Pending Uploads
            storeImgBase64: null,
            prodImgBase64: null
        };

        // --- INIT ---
        window.onload = async () => {
            await initLIFF();
            await loadStores(); // Fetch Store List
            loadCartLocal();
            renderHome();
            document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
        };

        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const p = await liff.getProfile();
                    app.user = { id: p.userId, name: p.displayName, img: p.pictureUrl };
                    document.getElementById('user-avatar').src = p.pictureUrl;
                    document.getElementById('user-avatar').classList.remove('hidden');
                } else {
                    liff.login();
                }
            } catch (e) { console.error('LIFF Error', e); }
        }

        async function loadStores() {
            try {
                const res = await fetch(`${GAS_URL}?action=getStores`);
                const json = await res.json();
                app.stores = json.stores || [];
            } catch (e) { alert('è¼‰å…¥å¤±æ•—'); }
        }

        // --- NAVIGATION ---
        function goHome() {
            app.view = 'home';
            app.currentStore = null;
            updateViewUI();
        }

        async function goToStore(storeId) {
            document.getElementById('loading-screen').classList.remove('opacity-0', 'pointer-events-none');
            try {
                const res = await fetch(`${GAS_URL}?action=getStoreData&storeId=${storeId}`);
                const json = await res.json();
                app.currentStore = {
                    info: json.store || {},
                    products: json.products || []
                };
                app.view = 'store';
                updateViewUI();
            } catch (e) { alert('é€²å…¥å•†åº—å¤±æ•—'); }
            document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
        }

        function toggleSellerMode() {
            if (app.view === 'seller') {
                goHome(); // Exit
            } else {
                app.view = 'seller';
                updateViewUI();
            }
        }

        function updateViewUI() {
            // Hide all views
            ['view-home', 'view-store', 'view-seller'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('cart-float-btn').classList.add('opacity-0', 'translate-y-20');
            document.getElementById('back-btn').classList.add('hidden');

            const sellerBtn = document.getElementById('seller-btn');

            if (app.view === 'home') {
                document.getElementById('view-home').classList.remove('hidden');
                document.getElementById('page-title').innerHTML = '<span class="text-2xl">ğŸ›ï¸</span> å¸‚é›†å¤§å»³';
                sellerBtn.innerHTML = '<span>æˆ‘è¦é–‹åº—</span>';
                sellerBtn.classList.replace('bg-orange-600', 'bg-stone-800');
                renderHome();
            }
            else if (app.view === 'store') {
                document.getElementById('view-store').classList.remove('hidden');
                document.getElementById('back-btn').classList.remove('hidden');

                const info = app.currentStore.info;
                document.getElementById('page-title').innerText = info.Name || 'Store';
                document.getElementById('store-page-name').innerText = info.Name || 'æœªå‘½åå•†åº—';
                document.getElementById('store-page-desc').innerText = info.Description || 'æ­¡è¿å…‰è‡¨';
                document.getElementById('store-cover-img').src = info.Image && info.Image.startsWith('http') ? info.Image : 'https://placehold.co/100';
                document.getElementById('store-ship-home').innerText = `ğŸšš å®…é… $${info.Shipping_Home || 100}`;
                document.getElementById('store-ship-store').innerText = `ğŸª è¶…å•† $${info.Shipping_Store || 60}`;

                renderProductGrid();
                updateCartUI(); // Show float button if cart has items
            }
            else if (app.view === 'seller') {
                document.getElementById('view-seller').classList.remove('hidden');
                document.getElementById('page-title').innerText = 'è³£å®¶ä¸­å¿ƒ';
                sellerBtn.innerHTML = '<span>å›å¤§å»³</span>';
                sellerBtn.classList.replace('bg-stone-800', 'bg-orange-600');

                // Pre-fill User Info if exists in store list
                const myStore = app.stores.find(s => s.StoreID === app.user.id);
                if (myStore) {
                    document.getElementById('set-store-name').value = myStore.Name;
                    document.getElementById('set-store-desc').value = myStore.Description;
                    document.getElementById('set-bank-info').value = myStore.BankInfo;
                    document.getElementById('preview-store-img').src = myStore.Image;
                    document.getElementById('preview-store-img').classList.remove('hidden');
                }
            }

            window.scrollTo(0, 0);
        }

        // --- RENDERERS ---
        function renderHome() {
            const container = document.getElementById('store-list');
            if (app.stores.length === 0) {
                container.innerHTML = '<p class="text-center text-stone-400 py-10">ç›®å‰æ²’æœ‰å•†åº—</p>';
                return;
            }
            container.innerHTML = app.stores.map(s => `
                <div onclick="goToStore('${s.StoreID}')" class="bg-white rounded-2xl p-4 shadow-sm flex items-center gap-4 active:scale-95 transition-transform cursor-pointer">
                    <img src="${s.Image && s.Image.startsWith('http') ? s.Image : 'https://placehold.co/80'}" class="w-16 h-16 rounded-full bg-stone-100 object-cover">
                    <div>
                        <h3 class="font-bold text-lg text-stone-800">${s.Name}</h3>
                        <p class="text-xs text-stone-500 line-clamp-1">${s.Description || 'No description'}</p>
                    </div>
                    <div class="ml-auto text-stone-300">âœ</div>
                </div>
            `).join('');
        }

        function renderProductGrid() {
            const container = document.getElementById('product-grid');
            const products = app.currentStore.products;
            if (products.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center text-stone-400 py-10">æ­¤å•†åº—å°šæœªä¸Šæ¶å•†å“</div>';
                return;
            }
            container.innerHTML = products.map((p, idx) => `
                <div onclick="openProductModal(${idx})" class="bg-white rounded-2xl p-3 shadow-sm active:scale-95 transition-transform cursor-pointer">
                    <img src="${p.Image && p.Image.startsWith('http') ? p.Image : 'https://placehold.co/200'}" class="w-full aspect-square rounded-xl object-cover bg-stone-100 mb-2">
                    <h4 class="font-bold text-stone-800 text-sm truncate">${p.Name}</h4>
                    <p class="text-orange-600 font-bold">$${p.Price}</p>
                </div>
            `).join('');
        }

        // --- CART LOGIC ---
        let currentModalProduct = null;
        let currentModalSpecs = {};

        function openProductModal(idx) {
            const p = app.currentStore.products[idx];
            currentModalProduct = p;
            currentModalSpecs = {};

            document.getElementById('modal-img').src = p.Image && p.Image.startsWith('http') ? p.Image : 'https://placehold.co/300';
            document.getElementById('modal-name').innerText = p.Name;
            document.getElementById('modal-price').innerText = `$${p.Price}`;
            document.getElementById('modal-qty').innerText = '1';

            // Render Specs
            const specs = JSON.parse(p.Specs || '{}');
            const container = document.getElementById('modal-specs');
            container.innerHTML = '';
            Object.keys(specs).forEach(key => {
                const vals = specs[key];
                const html = `
                    <div class="space-y-2">
                        <p class="text-xs font-bold text-stone-400">${key}</p>
                        <div class="flex flex-wrap gap-2">
                            ${vals.map((v, i) => `
                                <button onclick="selectSpec('${key}', '${v}')" class="spec-btn spec-${key}-${v} px-3 py-1.5 rounded-lg border border-stone-100 text-xs font-bold ${i === 0 ? 'bg-stone-800 text-white border-stone-800' : 'bg-white text-stone-500'}">
                                    ${v}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
                currentModalSpecs[key] = vals[0]; // Default first
            });

            const modal = document.getElementById('product-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.children[1].classList.remove('translate-y-full'), 10);
        }

        function selectSpec(key, val) {
            currentModalSpecs[key] = val;
            // Update UI
            document.querySelectorAll(`.spec-btn[class*="spec-${key}-"]`).forEach(el => {
                el.classList.remove('bg-stone-800', 'text-white', 'border-stone-800');
                el.classList.add('bg-white', 'text-stone-500');
            });
            const active = document.querySelector(`.spec-${key}-${val}`);
            active.classList.add('bg-stone-800', 'text-white', 'border-stone-800');
            active.classList.remove('bg-white', 'text-stone-500');
        }

        function updateModalQty(d) {
            let q = parseInt(document.getElementById('modal-qty').innerText) + d;
            if (q < 1) q = 1;
            document.getElementById('modal-qty').innerText = q;
        }

        function closeProductModal() {
            const modal = document.getElementById('product-modal');
            modal.children[1].classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function addToCart() {
            // Check Store Lock
            const storeId = app.currentStore.info.StoreID;
            if (app.cartStoreId && app.cartStoreId !== storeId) {
                if (!confirm('æ‚¨çš„è³¼ç‰©è»Šå…§å·²æœ‰å…¶ä»–å•†åº—çš„å•†å“ã€‚æ˜¯å¦æ¸…ç©ºè³¼ç‰©è»Šä»¥è³¼è²·æ­¤å•†åº—å•†å“ï¼Ÿ')) return;
                app.cart = [];
                app.cartStoreId = null;
            }

            app.cartStoreId = storeId;
            const item = {
                pid: currentModalProduct.ID,
                name: currentModalProduct.Name,
                price: currentModalProduct.Price,
                image: currentModalProduct.Image,
                spec: { ...currentModalSpecs },
                qty: parseInt(document.getElementById('modal-qty').innerText),
                storeId: storeId
            };

            // Check duplicate
            const specStr = JSON.stringify(item.spec);
            const exist = app.cart.find(i => i.pid === item.pid && JSON.stringify(i.spec) === specStr);
            if (exist) exist.qty += item.qty;
            else app.cart.push(item);

            saveCartLocal();
            closeProductModal();
            updateCartUI();

            // Animation
            confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 }, colors: ['#f97316'] });
        }

        // --- CART UI & ACTIONS ---
        function updateCartUI() {
            // Reset float btn
            const btn = document.getElementById('cart-float-btn');
            if (app.cart.length > 0 && app.view === 'store' && app.currentStore.info.StoreID === app.cartStoreId) {
                const count = app.cart.reduce((a, b) => a + b.qty, 0);
                const total = app.cart.reduce((a, b) => a + b.price * b.qty, 0);
                document.getElementById('cart-count').innerText = count;
                document.getElementById('cart-total-float').innerText = `$${total}`;
                btn.classList.remove('opacity-0', 'translate-y-20');
            } else {
                btn.classList.add('opacity-0', 'translate-y-20');
            }
        }

        function openCart() {
            const modal = document.getElementById('cart-modal');
            renderCartItems();
            modal.classList.remove('hidden');
            setTimeout(() => document.getElementById('cart-panel').classList.remove('translate-y-full'), 10);
        }

        function closeCart() {
            document.getElementById('cart-panel').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('cart-modal').classList.add('hidden'), 300);
        }

        function clearCart() {
            app.cart = [];
            app.cartStoreId = null;
            saveCartLocal();
            closeCart();
            updateCartUI();
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            if (app.cart.length === 0) { container.innerHTML = '<p class="text-center text-stone-400 py-10">ç©ºç©ºå¦‚ä¹Ÿ</p>'; return; }

            container.innerHTML = app.cart.map((item, idx) => `
                <div class="flex gap-3 bg-white p-3 rounded-2xl shadow-sm border border-stone-50">
                    <img src="${item.image}" class="w-14 h-14 rounded-lg bg-stone-100 object-cover" onerror="this.src='https://placehold.co/100'">
                    <div class="flex-grow">
                        <h4 class="font-bold text-stone-800">${item.name}</h4>
                        <p class="text-xs text-stone-400">${Object.values(item.spec).join('/')}</p>
                        <p class="text-orange-600 font-bold">$${item.price}</p>
                    </div>
                     <div class="flex items-center gap-2 bg-stone-100 rounded-lg p-1 h-8 self-end">
                        <button onclick="updateCartQty(${idx}, -1)" class="w-6 font-bold text-stone-500">-</button>
                        <span class="text-xs font-bold w-4 text-center">${item.qty}</span>
                        <button onclick="updateCartQty(${idx}, 1)" class="w-6 font-bold text-stone-500">+</button>
                    </div>
                </div>
            `).join('');
            calcTotal();
        }

        function updateCartQty(idx, d) {
            app.cart[idx].qty += d;
            if (app.cart[idx].qty <= 0) app.cart.splice(idx, 1);
            if (app.cart.length === 0) clearCart();
            else {
                saveCartLocal();
                renderCartItems();
                updateCartUI();
            }
        }

        function setShipMethod(m) {
            app.shippingMethod = m;
            document.getElementById('btn-ship-store').className = m === 'store' ? "flex-1 py-2 rounded-lg border border-stone-800 bg-stone-800 text-white" : "flex-1 py-2 rounded-lg border border-stone-200 text-stone-400";
            document.getElementById('btn-ship-home').className = m === 'home' ? "flex-1 py-2 rounded-lg border border-stone-800 bg-stone-800 text-white" : "flex-1 py-2 rounded-lg border border-stone-200 text-stone-400";
            calcTotal();
        }

        function calcTotal() {
            const subtotal = app.cart.reduce((a, b) => a + b.price * b.qty, 0);
            const shipFee = app.shippingMethod === 'home'
                ? parseInt(app.currentStore.info.Shipping_Home || 100)
                : parseInt(app.currentStore.info.Shipping_Store || 60);

            document.getElementById('cart-subtotal').innerText = subtotal;
            document.getElementById('cart-shipping').innerText = shipFee;
            document.getElementById('cart-final-total').innerText = subtotal + shipFee;
        }

        async function submitOrder() {
            const name = document.getElementById('chk-name').value;
            const phone = document.getElementById('chk-phone').value;
            const addr = document.getElementById('chk-addr').value; // Keeping it simple for refactor phase

            if (!name || !phone || !addr) return alert('è«‹å¡«å¯«å®Œæ•´æ”¶ä»¶è³‡è¨Š');

            const btn = document.getElementById('btn-checkout');
            btn.innerHTML = 'è™•ç†ä¸­...';
            btn.disabled = true;

            const subtotal = app.cart.reduce((a, b) => a + b.price * b.qty, 0);
            const shipFee = app.shippingMethod === 'home' ? parseInt(app.currentStore.info.Shipping_Home || 100) : parseInt(app.currentStore.info.Shipping_Store || 60);

            const payload = {
                action: 'submitOrder',
                data: {
                    storeId: app.cartStoreId,
                    memberId: app.user.id,
                    memberName: app.user.name,
                    recipientName: name,
                    recipientPhone: phone,
                    method: app.shippingMethod,
                    address: addr,
                    items: app.cart,
                    total: subtotal + shipFee
                }
            };

            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === 'success') {
                    alert('ğŸ‰ è¨‚å–®å·²é€å‡ºï¼');
                    clearCart();
                } else alert('Error: ' + json.message);
            } catch (e) { alert('é€£ç·šå¤±æ•—'); }

            btn.innerHTML = 'ç¢ºèªçµå¸³';
            btn.disabled = false;
        }

        // --- SELLER API ---
        function handleStoreImage(inp) { handleImage(inp, 'preview-store-img', (b64) => app.storeImgBase64 = b64); }
        function handleProdImage(inp) { handleImage(inp, 'preview-prod-img', (b64) => app.prodImgBase64 = b64); }

        function handleImage(inp, previewId, callback) {
            if (inp.files && inp.files[0]) {
                const r = new FileReader();
                r.onload = (e) => {
                    document.getElementById(previewId).src = e.target.result;
                    document.getElementById(previewId).classList.remove('hidden');
                    callback(e.target.result);
                };
                r.readAsDataURL(inp.files[0]);
            }
        }

        // Save Store Settings
        async function saveStoreSettings() {
            const btn = document.getElementById('btn-save-store');
            btn.innerHTML = 'å„²å­˜ä¸­...'; btn.disabled = true;

            const payload = {
                action: 'updateStore',
                data: {
                    storeId: app.user.id,
                    name: document.getElementById('set-store-name').value,
                    desc: document.getElementById('set-store-desc').value,
                    bankInfo: document.getElementById('set-bank-info').value,
                    shipHome: document.getElementById('set-ship-home').value,
                    shipStore: document.getElementById('set-ship-store').value,
                    imageBase64: app.storeImgBase64
                }
            };

            // Send
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === 'success') alert('âœ… å•†åº—è¨­å®šå·²æ›´æ–°');
                else alert('æ›´æ–°å¤±æ•—');
            } catch (e) { alert('Error'); }

            btn.innerHTML = 'å„²å­˜å•†åº—è¨­å®š'; btn.disabled = false;
        }

        // Create Product
        async function submitProduct() {
            if (!app.prodImgBase64) return alert('è«‹ä¸Šå‚³å•†å“ç…§');
            const btn = document.getElementById('submit-prod-btn');
            btn.innerHTML = 'ä¸Šæ¶ä¸­...'; btn.disabled = true;

            // Collect Specs (Simplified)
            const specs = {};
            document.querySelectorAll('#specs-container > div').forEach(div => {
                const k = div.querySelector('.spec-key').value;
                const v = div.querySelector('.spec-vals').value;
                if (k) specs[k] = v.split(',');
            });

            const payload = {
                action: 'createProduct',
                data: {
                    sellerId: app.user.id,
                    sellerName: app.user.name,
                    name: document.getElementById('prod-name').value,
                    price: document.getElementById('prod-price').value,
                    category: document.getElementById('prod-cat').value,
                    specs: specs,
                    imageBase64: app.prodImgBase64
                }
            };

            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === 'success') {
                    alert('âœ… ä¸Šæ¶æˆåŠŸ');
                    document.getElementById('sell-form').reset();
                    app.prodImgBase64 = null;
                    document.getElementById('preview-prod-img').classList.add('hidden');
                } else alert('ä¸Šæ¶å¤±æ•—');
            } catch (e) { alert('Error'); }

            btn.innerHTML = 'ç¢ºèªä¸Šæ¶'; btn.disabled = false;
        }

        function addSpecLine() {
            const d = document.createElement('div');
            d.className = "flex gap-2";
            d.innerHTML = '<input class="spec-key w-1/3 p-2 rounded text-xs" placeholder="è¦æ ¼å"><input class="spec-vals flex-1 p-2 rounded text-xs" placeholder="é¸é …1,é¸é …2">';
            document.getElementById('specs-container').appendChild(d);
        }

        // --- STORAGE ---
        function saveCartLocal() {
            localStorage.setItem('cart', JSON.stringify(app.cart));
            localStorage.setItem('cartStoreId', app.cartStoreId || '');
        }
        function loadCartLocal() {
            const c = localStorage.getItem('cart');
            if (c) app.cart = JSON.parse(c);
            app.cartStoreId = localStorage.getItem('cartStoreId');
        }

    </script>
</body>

</html>
