<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç·šä¸Šè¨‚è³¼ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .btn-press:active {
            transform: scale(0.97);
        }

        .shimmer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.8) 50%, transparent 100%);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(100%);
            }
        }
    </style>
</head>

<body class="bg-stone-50 text-stone-800 pb-24">

    <!-- Loading Screen -->
    <div id="loading-screen"
        class="fixed inset-0 z-50 bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-stone-200 border-t-stone-800 rounded-full animate-spin mb-4"></div>
        <p class="text-sm font-bold text-stone-400 tracking-widest animate-pulse">LOADING STORE</p>
    </div>

    <!-- Header -->
    <header
        class="fixed top-0 left-0 right-0 z-40 glass border-b border-stone-100 shadow-sm transition-all duration-300"
        id="main-header">
        <div class="max-w-md mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-black tracking-tight flex items-center gap-2" id="store-name">
                <span class="text-2xl">ğŸ›ï¸</span> è¼‰å…¥ä¸­...
            </h1>
            <div class="flex items-center gap-3">
                <!-- Mode Toggle -->
                <button onclick="toggleMode()" id="mode-btn"
                    class="bg-stone-800 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-sm transition-all active:scale-95 flex items-center gap-1">
                    <span>Store</span>
                    <svg class="w-3 h-3 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                </button>
                <!-- User Avatar (LIFF) -->
                <div id="user-info" class="hidden flex items-center gap-2 bg-stone-100 pl-1 pr-3 py-1 rounded-full">
                    <img id="user-avatar" src="" class="w-6 h-6 rounded-full bg-stone-300 object-cover">
                    <span id="user-name" class="text-xs font-bold text-stone-600 truncate max-w-[80px]">Visitor</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-md mx-auto pt-24 px-4 space-y-6">

        <!-- Hero Banner -->
        <div class="relative bg-stone-800 rounded-3xl p-8 text-white overflow-hidden shadow-xl shadow-stone-200">
            <div class="absolute -right-10 -top-10 w-48 h-48 bg-stone-700 rounded-full opacity-50 blur-3xl"></div>
            <div class="absolute -left-10 -bottom-10 w-32 h-32 bg-orange-500 rounded-full opacity-30 blur-2xl"></div>
            <div class="relative z-10">
                <p class="text-xs font-bold text-orange-300 tracking-[0.2em] mb-2 uppercase">New Arrival</p>
                <h2 class="text-3xl font-black leading-tight mb-4">ç²¾å¿ƒæŒ‘é¸<br>ç‚ºæ‚¨å‘ˆç¾</h2>
                <p class="text-stone-400 text-xs font-medium max-w-[80%]">ç€è¦½æˆ‘å€‘çš„æœ€æ–°å•†å“ï¼Œäº«å—ç°¡å–®å¿«é€Ÿçš„è¨‚è³¼é«”é©—ã€‚</p>
            </div>
        </div>

        <!-- Product Grid -->
        <h3 class="font-black text-xl px-2 flex items-center justify-between">
            <span>ç†±é–€å•†å“</span>
            <span class="text-xs font-bold text-stone-400 bg-stone-200/50 px-2 py-1 rounded-md" id="product-count">0
                items</span>
        </h3>

        <div id="product-grid" class="grid grid-cols-2 gap-4 pb-10">
            <!-- Skeleton Loader -->
            <div class="bg-white rounded-2xl p-4 shadow-sm space-y-3">
                <div class="w-full aspect-square bg-stone-100 rounded-xl animate-pulse"></div>
                <div class="h-4 bg-stone-100 rounded w-2/3 animate-pulse"></div>
                <div class="h-4 bg-stone-100 rounded w-1/3 animate-pulse"></div>
            </div>
            <div class="bg-white rounded-2xl p-4 shadow-sm space-y-3">
                <div class="w-full aspect-square bg-stone-100 rounded-xl animate-pulse"></div>
                <div class="h-4 bg-stone-100 rounded w-2/3 animate-pulse"></div>
                <div class="h-4 bg-stone-100 rounded w-1/3 animate-pulse"></div>
            </div>
        </div>

    </main>

    <!-- Sell View (Hidden by default) -->
    <main id="sell-view" class="hidden max-w-md mx-auto pt-24 px-6 space-y-6 pb-24">
        <h2 class="text-2xl font-black text-stone-800">ä¸Šæ¶æ‚¨çš„å•†å“</h2>

        <form id="sell-form" class="space-y-6" onsubmit="event.preventDefault(); submitProduct();">
            <!-- Image Upload -->
            <div class="space-y-2">
                <label class="block text-xs font-bold text-stone-400">å•†å“åœ–ç‰‡</label>
                <div class="relative w-full aspect-square bg-white rounded-3xl border-2 border-dashed border-stone-200 flex flex-col items-center justify-center cursor-pointer hover:border-orange-400 transition-colors overflow-hidden group"
                    onclick="document.getElementById('img-input').click()">
                    <img id="preview-img" class="absolute inset-0 w-full h-full object-cover hidden">
                    <div class="text-center group-hover:scale-110 transition-transform">
                        <span class="text-4xl">ğŸ“¸</span>
                        <p class="text-xs font-bold text-stone-400 mt-2">é»æ“Šä¸Šå‚³åœ–ç‰‡</p>
                    </div>
                </div>
                <input type="file" id="img-input" accept="image/*" class="hidden" onchange="handleImageSelect(this)">
            </div>

            <!-- Basic Info -->
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-stone-400 mb-1">å•†å“åç¨±</label>
                    <input type="text" id="prod-name" required
                        class="w-full bg-white border border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:ring-2 focus:ring-stone-800"
                        placeholder="ä¾‹å¦‚ï¼šæ‰‹ä½œé¤…ä¹¾">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-stone-400 mb-1">åƒ¹æ ¼ ($)</label>
                        <input type="number" id="prod-price" required min="1"
                            class="w-full bg-white border border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:ring-2 focus:ring-stone-800"
                            placeholder="100">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-400 mb-1">åˆ†é¡</label>
                        <input type="text" id="prod-cat" required list="cat-list"
                            class="w-full bg-white border border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:ring-2 focus:ring-stone-800"
                            placeholder="é£Ÿå“">
                        <datalist id="cat-list">
                            <option value="é£Ÿå“">
                            <option value="èŠ±è—">
                            <option value="ç”¨å“">
                        </datalist>
                    </div>
                </div>
            </div>

            <!-- Specs (Simple) -->
            <div class="space-y-2 bg-white p-4 rounded-2xl border border-stone-100">
                <label class="block text-xs font-bold text-stone-400 mb-2">å•†å“è¦æ ¼ (é¸é …)</label>
                <div id="specs-container" class="space-y-3">
                    <!-- Dynamic Spec Lines -->
                    <div class="flex gap-2">
                        <input type="text" placeholder="è¦æ ¼åç¨± (å¦‚: å£å‘³)"
                            class="spec-key w-1/3 bg-stone-50 text-xs font-bold p-2 rounded-lg outline-none" value="æ¨£å¼">
                        <input type="text" placeholder="é¸é … (ç”¨é€—è™Ÿéš”é–‹, å¦‚: ç´…è‰²,è—è‰²)"
                            class="spec-vals flex-grow bg-stone-50 text-xs font-bold p-2 rounded-lg outline-none">
                    </div>
                </div>
                <button type="button" onclick="addSpecLine()"
                    class="text-xs font-bold text-orange-500 hover:underline">+ å¢åŠ è¦æ ¼</button>
            </div>

            <button type="submit" id="submit-prod-btn"
                class="w-full bg-stone-900 text-white font-bold py-4 rounded-2xl shadow-lg btn-press">
                ç¢ºèªä¸Šæ¶
            </button>
        </form>
    </main>

    <!-- Floating Cart Button -->
    <div class="fixed bottom-6 left-0 right-0 z-30 pointer-events-none">
        <div class="max-w-md mx-auto px-6 flex justify-center">
            <button id="cart-btn" onclick="openCart()"
                class="pointer-events-auto bg-stone-900 text-white pl-6 pr-2 py-2 rounded-full shadow-2xl shadow-stone-400 flex items-center gap-4 transform translate-y-20 opacity-0 transition-all duration-300 hover:scale-105 active:scale-95">
                <span class="font-bold text-sm">æŸ¥çœ‹è³¼ç‰©è»Š</span>
                <span
                    class="bg-white text-stone-900 w-8 h-8 rounded-full flex items-center justify-center font-black text-xs"
                    id="cart-count">0</span>
            </button>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="product-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeProductModal()">
        </div>
        <div
            class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2rem] max-h-[90vh] overflow-hidden flex flex-col transition-transform transform translate-y-full duration-300 max-w-md mx-auto shadow-2xl">
            <!-- Modal Content (Dynamic) -->
            <div class="overflow-y-auto p-6 space-y-6 pb-32 hide-scrollbar" id="product-modal-content">
                <!-- Injected via JS -->
            </div>
            <!-- Bottom Action -->
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-white border-t border-stone-100">
                <button id="add-to-cart-btn" onclick="addToCart()"
                    class="w-full bg-stone-900 text-white font-bold py-4 rounded-2xl shadow-lg btn-press">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
        </div>
    </div>

    <!-- Cart / Checkout Modal -->
    <div id="cart-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-stone-100 transition-transform transform translate-y-full duration-300 flex flex-col max-w-md mx-auto"
            id="cart-panel">
            <!-- Header -->
            <div class="bg-white px-6 py-4 flex items-center justify-between border-b border-stone-100 shadow-sm z-10">
                <h2 class="text-lg font-black" id="cart-title">è³¼ç‰©è»Š</h2>
                <button onclick="closeCart()"
                    class="p-2 bg-stone-100 rounded-full hover:bg-stone-200 transition-colors">
                    <svg class="w-5 h-5 text-stone-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-grow overflow-y-auto px-6 py-6 pb-40 space-y-8 hide-scrollbar">

                <!-- Cart Items -->
                <div id="cart-items-container" class="space-y-4">
                    <!-- Injected -->
                </div>

                <!-- Checkout Form -->
                <div id="checkout-form" class="hidden space-y-8 animate-fade-in">

                    <!-- Section: Shipping -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100 space-y-4">
                        <h3 class="font-bold text-stone-800 flex items-center gap-2 text-sm uppercase tracking-wider">
                            <span
                                class="w-6 h-6 bg-stone-800 text-white rounded-md flex items-center justify-center text-xs">1</span>
                            é…é€æ–¹å¼
                        </h3>
                        <div class="grid grid-cols-3 gap-2">
                            <button type="button" onclick="setMethod('store')" required id="btn-method-store"
                                class="py-3 rounded-xl border-2 border-stone-100 text-xs font-bold text-stone-500 hover:border-stone-300 transition-all active-method">è¶…å•†å–è²¨</button>
                            <button type="button" onclick="setMethod('home')" required id="btn-method-home"
                                class="py-3 rounded-xl border-2 border-stone-100 text-xs font-bold text-stone-500 hover:border-stone-300 transition-all">å®…é…é‹é€</button>
                            <button type="button" onclick="setMethod('self')" required id="btn-method-self"
                                class="py-3 rounded-xl border-2 border-stone-100 text-xs font-bold text-stone-500 hover:border-stone-300 transition-all">ç¾å ´è‡ªå–</button>
                        </div>

                        <!-- Address / Store / Pickup Info Fields -->
                        <div id="shipping-forms" class="pt-2 animate-fade-in">

                            <!-- 1. Store Pickup Form -->
                            <div id="form-store" class="hidden space-y-3">
                                <label class="block text-xs font-bold text-stone-400">é¸æ“‡å–è²¨é–€å¸‚</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <select id="store-type"
                                        class="bg-stone-50 border border-stone-200 rounded-xl px-3 py-3 font-bold text-stone-700 outline-none">
                                        <option value="7-11">7-ELEVEN</option>
                                        <option value="FamilyMart">å…¨å®¶ä¾¿åˆ©å•†åº—</option>
                                        <option value="Hi-Life">èŠçˆ¾å¯Œ</option>
                                        <option value="OK">OKè¶…å•†</option>
                                    </select>
                                    <input type="text" id="store-name" placeholder="é–€å¸‚åç¨±/åº—è™Ÿ"
                                        class="bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <select id="store-city" onchange="renderDistricts('store')"
                                        class="city-select bg-stone-50 border border-stone-200 rounded-xl px-3 py-3 font-bold text-stone-700 outline-none">
                                        <option value="">é¸æ“‡ç¸£å¸‚</option>
                                    </select>
                                    <select id="store-dist"
                                        class="dist-select bg-stone-50 border border-stone-200 rounded-xl px-3 py-3 font-bold text-stone-700 outline-none">
                                        <option value="">é¸æ“‡å€åŸŸ</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 2. Home Delivery Form -->
                            <div id="form-home" class="hidden space-y-3">
                                <label class="block text-xs font-bold text-stone-400">å®…é…åœ°å€</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <select id="home-city" onchange="renderDistricts('home')"
                                        class="city-select bg-stone-50 border border-stone-200 rounded-xl px-3 py-3 font-bold text-stone-700 outline-none">
                                        <option value="">é¸æ“‡ç¸£å¸‚</option>
                                    </select>
                                    <select id="home-dist"
                                        class="dist-select bg-stone-50 border border-stone-200 rounded-xl px-3 py-3 font-bold text-stone-700 outline-none">
                                        <option value="">é¸æ“‡å€åŸŸ</option>
                                    </select>
                                </div>
                                <input type="text" id="home-addr" placeholder="è¡—é“å··å¼„è™Ÿæ¨“"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none">
                            </div>

                            <!-- 3. Self Pickup Form -->
                            <div id="form-self" class="hidden space-y-3">
                                <label class="block text-xs font-bold text-stone-400">é è¨ˆå–è²¨æ™‚é–“</label>
                                <input type="datetime-local" id="self-time"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none">
                                <p class="text-[10px] text-stone-400 pl-1">è«‹é¸æ“‡æ‚¨æ–¹ä¾¿å‰ä¾†å–è²¨çš„æ™‚æ®µ</p>
                            </div>

                        </div>
                    </div>

                    <!-- Section: Recipient -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-stone-100 space-y-4">
                        <h3 class="font-bold text-stone-800 flex items-center gap-2 text-sm uppercase tracking-wider">
                            <span
                                class="w-6 h-6 bg-stone-800 text-white rounded-md flex items-center justify-center text-xs">2</span>
                            æ”¶ä»¶äººè³‡æ–™
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-bold text-stone-400 mb-1">çœŸå¯¦å§“å <span
                                        class="text-red-400">*</span></label>
                                <input type="text" id="input-r-name"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:ring-2 focus:ring-stone-800 focus:border-transparent"
                                    placeholder="ç‹å°æ˜">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-400 mb-1">è¯çµ¡æ‰‹æ©Ÿ <span
                                        class="text-red-400">*</span></label>
                                <input type="tel" id="input-r-phone"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:ring-2 focus:ring-stone-800 focus:border-transparent"
                                    placeholder="0912345678">
                            </div>
                        </div>
                        <!-- LIFF Hint -->
                        <div
                            class="flex items-center gap-2 bg-blue-50 p-3 rounded-lg text-[10px] text-blue-600 font-bold border border-blue-100">
                            <span class="text-lg">â„¹ï¸</span>
                            <span>LINE å¸³è™Ÿ <span id="checkout-liff-name" class="underline">...</span> å°‡ä½œç‚ºæœƒå“¡èº«åˆ†è¨˜éŒ„ã€‚</span>
                        </div>
                    </div>

                    <!-- Section: Payment Info -->
                    <div class="bg-stone-800 p-6 rounded-2xl shadow-lg text-white relative overflow-hidden">
                        <div class="relative z-10 space-y-2">
                            <p class="text-[10px] text-stone-400 uppercase tracking-widest font-bold">åŒ¯æ¬¾è½‰å¸³è³‡è¨Š</p>
                            <p class="whitespace-pre-line font-mono text-sm leading-relaxed opacity-90" id="bank-info">
                                è¼‰å…¥ä¸­...</p>
                        </div>
                        <div class="absolute right-0 bottom-0 opacity-10 transform translate-x-4 translate-y-4">
                            <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M2 10h20v7a2 2 0 01-2 2H4a2 2 0 01-2-2v-7zm0-4h20v2H2V6zm2-4h16a2 2 0 012 2v1H2V4a2 2 0 012-2z" />
                            </svg>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Footer Bar -->
            <div
                class="absolute bottom-0 left-0 right-0 bg-white border-t border-stone-100 p-6 z-20 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-xs font-bold text-stone-400">ç¸½é‡‘é¡ (å«é‹è²»)</span>
                    <span class="text-3xl font-black text-stone-800 tracking-tight" id="cart-total">$0</span>
                </div>
                <button id="checkout-btn" onclick="proceedToCheckout()"
                    class="w-full bg-stone-900 text-white font-bold py-4 rounded-2xl shadow-lg btn-press flex items-center justify-center gap-2">
                    <span>å‰å¾€çµå¸³</span>
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Init Script -->
    <script>
        // --- Configurations ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby0eaLjowGyKy5DDWgGT0mfDIod8zEXgy4-hdeYW4pPoQ_OaWu8K1KPh8V-V0o-ZeA/exec';
        const LIFF_ID = '2008678090-eGItUWQx';

        // --- TW Cities Data ---
        const TW_CITIES = {
            "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
            "è‡ºåŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
            "æ–°åŒ—å¸‚": ["è¬é‡Œå€", "é‡‘å±±å€", "æ¿æ©‹å€", "æ±æ­¢å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "ç‘èŠ³å€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "æ–°åº—å€", "åªæ—å€", "çƒä¾†å€", "æ°¸å’Œå€", "ä¸­å’Œå€", "åœŸåŸå€", "ä¸‰å³½å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰é‡å€", "æ–°èŠå€", "æ³°å±±å€", "æ—å£å€", "è˜†æ´²å€", "äº”è‚¡å€", "å…«é‡Œå€", "æ·¡æ°´å€", "ä¸‰èŠå€", "çŸ³é–€å€"],
            "æ¡ƒåœ’å¸‚": ["ä¸­å£¢å€", "å¹³é®å€", "é¾æ½­å€", "æ¥Šæ¢…å€", "æ–°å±‹å€", "è§€éŸ³å€", "æ¡ƒåœ’å€", "é¾œå±±å€", "å…«å¾·å€", "å¤§æºªå€", "å¾©èˆˆå€", "å¤§åœ’å€", "è˜†ç«¹å€"],
            "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
            "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "æ¹–å£é„‰", "æ–°è±é„‰", "æ–°åŸ”é®", "é—œè¥¿é®", "èŠæ—é„‰", "å¯¶å±±é„‰", "ç«¹æ±é®", "äº”å³°é„‰", "æ©«å±±é„‰", "å°–çŸ³é„‰", "åŒ—åŸ”é„‰", "å³¨çœ‰é„‰"],
            "è‹—æ —ç¸£": ["ç«¹å—é®", "é ­ä»½å¸‚", "ä¸‰ç£é„‰", "å—åº„é„‰", "ç…æ½­é„‰", "å¾Œé¾é®", "é€šéœ„é®", "è‹‘è£¡é®", "è‹—æ —å¸‚", "é€ æ©‹é„‰", "é ­å±‹é„‰", "å…¬é¤¨é„‰", "å¤§æ¹–é„‰", "æ³°å®‰é„‰", "éŠ…é‘¼é„‰", "ä¸‰ç¾©é„‰", "è¥¿æ¹–é„‰", "å“è˜­é®"],
            "è‡ºä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "åé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "å’Œå¹³å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€"],
            "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "èŠ¬åœ’é„‰", "èŠ±å£‡é„‰", "ç§€æ°´é„‰", "é¹¿æ¸¯é®", "ç¦èˆˆé„‰", "ç·šè¥¿é„‰", "å’Œç¾é®", "ä¼¸æ¸¯é„‰", "å“¡æ—å¸‚", "ç¤¾é ­é„‰", "æ°¸é–é„‰", "åŸ”å¿ƒé„‰", "æºªæ¹–é®", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "ç”°ä¸­é®", "åŒ—æ–—é®", "ç”°å°¾é„‰", "åŸ¤é ­é„‰", "æºªå·é„‰", "ç«¹å¡˜é„‰", "äºŒæ—é®", "å¤§åŸé„‰", "èŠ³è‹‘é„‰", "äºŒæ°´é„‰"],
            "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "ä¸­å¯®é„‰", "è‰å±¯é®", "åœ‹å§“é„‰", "åŸ”é‡Œé®", "ä»æ„›é„‰", "åé–“é„‰", "é›†é›†é®", "æ°´é‡Œé„‰", "é­šæ± é„‰", "ä¿¡ç¾©é„‰", "ç«¹å±±é®", "é¹¿è°·é„‰"],
            "é›²æ—ç¸£": ["æ–—å—é®", "å¤§åŸ¤é„‰", "è™å°¾é®", "åœŸåº«é®", "è¤’å¿ é„‰", "æ±å‹¢é„‰", "è‡ºè¥¿é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ–—å…­å¸‚", "æ—å…§é„‰", "å¤å‘é„‰", "è¿æ¡é„‰", "è¥¿èºé®", "äºŒå´™é„‰", "åŒ—æ¸¯é®", "æ°´æ—é„‰", "å£æ¹–é„‰", "å››æ¹–é„‰", "å…ƒé•·é„‰"],
            "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
            "å˜‰ç¾©ç¸£": ["ç•ªè·¯é„‰", "æ¢…å±±é„‰", "ç«¹å´é„‰", "é˜¿é‡Œå±±é„‰", "ä¸­åŸ”é„‰", "å¤§åŸ”é„‰", "æ°´ä¸Šé„‰", "é¹¿è‰é„‰", "å¤ªä¿å¸‚", "æœ´å­å¸‚", "æ±çŸ³é„‰", "å…­è…³é„‰", "æ–°æ¸¯é„‰", "æ°‘é›„é„‰", "å¤§æ—é®", "æºªå£é„‰", "ç¾©ç«¹é„‰", "å¸ƒè¢‹é®"],
            "è‡ºå—å¸‚": ["ä¸­è¥¿å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å¹³å€", "å®‰å—å€", "æ°¸åº·å€", "æ­¸ä»å€", "æ–°åŒ–å€", "å·¦é®å€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "ä»å¾·å€", "é—œå»Ÿå€", "é¾å´å€", "å®˜ç”°å€", "éº»è±†å€", "ä½³é‡Œå€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "å­¸ç”²å€", "åŒ—é–€å€", "æ–°ç‡Ÿå€", "å¾Œå£å€", "ç™½æ²³å€", "æ±å±±å€", "å…­ç”²å€", "ä¸‹ç‡Ÿå€", "æŸ³ç‡Ÿå€", "é¹½æ°´å€", "å–„åŒ–å€", "å¤§å…§å€", "å±±ä¸Šå€", "æ–°å¸‚å€", "å®‰å®šå€"],
            "é«˜é›„å¸‚": ["æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "é¹½åŸ•å€", "é¼“å±±å€", "æ——æ´¥å€", "å‰é®å€", "ä¸‰æ°‘å€", "æ¥ æ¢“å€", "å°æ¸¯å€", "å·¦ç‡Ÿå€", "ä»æ­¦å€", "å¤§ç¤¾å€", "æ±æ²™ç¾¤å³¶", "å—æ²™ç¾¤å³¶", "å²¡å±±å€", "è·¯ç«¹å€", "é˜¿è“®å€", "ç”°å¯®å€", "ç‡•å·¢å€", "æ©‹é ­å€", "æ¢“å®˜å€", "å½Œé™€å€", "æ°¸å®‰å€", "æ¹–å…§å€", "é³³å±±å€", "å¤§å¯®å€", "æ—åœ’å€", "é³¥æ¾å€", "å¤§æ¨¹å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "å…§é–€å€", "æ‰æ—å€", "ç”²ä»™å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€", "èŒ‚æ—å€", "èŒ„è£å€"],
            "å±æ±ç¸£": ["å±æ±å¸‚", "ä¸‰åœ°é–€é„‰", "éœ§è‡ºé„‰", "ç‘ªå®¶é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é«˜æ¨¹é„‰", "é¹½åŸ”é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ç«¹ç”°é„‰", "å…§åŸ”é„‰", "è¬ä¸¹é„‰", "æ½®å·é®", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "è¬å·’é„‰", "å´é ‚é„‰", "æ–°åŸ¤é„‰", "å—å·é„‰", "æ—é‚Šé„‰", "æ±æ¸¯é®", "ç‰çƒé„‰", "ä½³å†¬é„‰", "æ–°åœ’é„‰", "æ‹å¯®é„‰", "æ‹å±±é„‰", "æ˜¥æ—¥é„‰", "ç…å­é„‰", "è»ŠåŸé„‰", "ç‰¡ä¸¹é„‰", "æ†æ˜¥é®", "æ»¿å·é„‰"],
            "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "ç¾…æ±é®", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "äº”çµé„‰", "å†¬å±±é„‰", "è˜‡æ¾³é®", "å—æ¾³é„‰"],
            "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "æ–°åŸé„‰", "ç§€æ—é„‰", "å‰å®‰é„‰", "å£½è±é„‰", "é³³æ—é®", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "è¬æ¦®é„‰", "ç‰é‡Œé®", "å“æºªé„‰", "å¯Œé‡Œé„‰"],
            "è‡ºæ±ç¸£": ["è‡ºæ±å¸‚", "ç¶ å³¶é„‰", "è˜­å¶¼é„‰", "å»¶å¹³é„‰", "å‘å—é„‰", "é¹¿é‡é„‰", "é—œå±±é®", "æµ·ç«¯é„‰", "æ± ä¸Šé„‰", "æ±æ²³é„‰", "æˆåŠŸé®", "é•·æ¿±é„‰", "å¤ªéº»é‡Œé„‰", "é‡‘å³°é„‰", "å¤§æ­¦é„‰", "é”ä»é„‰"],
            "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰", "ç™½æ²™é„‰", "æ¹–è¥¿é„‰"],
            "é‡‘é–€ç¸£": ["é‡‘æ²™é®", "é‡‘æ¹–é®", "é‡‘å¯§é„‰", "é‡‘åŸé®", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
            "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"]
        };


        // --- State ---
        let appState = {
            mode: 'buy', // buy | sell
            products: [],
            settings: {},
            cart: [], // { id, name, price, qty, spec: {key: val} }
            shippingMethod: 'store', // store, home, self
            user: { userId: 'Guest', displayName: 'Guest', pictureUrl: '' }
        };

        // --- Init ---
        window.onload = async () => {
            await initLIFF();
            initCitySelects(); // Setup dropdowns
            await fetchData();
            loadCart();
            updateUI();
            document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
        };

        function initCitySelects() {
            const cities = Object.keys(TW_CITIES);
            document.querySelectorAll('.city-select').forEach(sel => {
                sel.innerHTML = '<option value="">é¸æ“‡ç¸£å¸‚</option>' + cities.map(c => `<option value="${c}">${c}</option>`).join('');
            });
        }

        function renderDistricts(type) {
            const city = document.getElementById(`${type}-city`).value;
            const target = document.getElementById(`${type}-dist`);
            if (!city) {
                target.innerHTML = '<option value="">é¸æ“‡å€åŸŸ</option>';
                return;
            }
            const dists = TW_CITIES[city];
            target.innerHTML = '<option value="">é¸æ“‡å€åŸŸ</option>' + dists.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    appState.user = profile;
                    // Update UI
                    document.getElementById('user-info').classList.remove('hidden');
                    document.getElementById('user-name').innerText = profile.displayName;
                    document.getElementById('checkout-liff-name').innerText = profile.displayName;
                    if (profile.pictureUrl) document.getElementById('user-avatar').src = profile.pictureUrl;
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF Error:', err);
            }
        }

        async function fetchData() {
            try {
                const res = await fetch(`${GAS_URL}?action=getData`);
                const data = await res.json();
                appState.products = data.products || [];
                appState.settings = data.settings || {};

                // Update Settings UI
                document.getElementById('store-name').innerHTML = `<span class="text-2xl">ğŸ›ï¸</span> ${appState.settings.StoreName || 'Store'}`;
                document.getElementById('bank-info').innerText = appState.settings.BankInfo || 'ç„¡åŒ¯æ¬¾è³‡è¨Š';

                renderProducts();
            } catch (e) {
                alert('è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            }
        }

        // --- Components ---
        function renderProducts() {
            const container = document.getElementById('product-grid');
            document.getElementById('product-count').innerText = `${appState.products.length} items`;

            if (appState.products.length === 0) {
                container.innerHTML = '<div class="col-span-2 text-center py-10 text-stone-400">ç›®å‰æ²’æœ‰å•†å“ä¸Šæ¶</div>';
                return;
            }

            container.innerHTML = appState.products.map(p => `
                <div onclick="openProductModal('${p.ID}')" class="bg-white rounded-3xl p-4 shadow-sm active:scale-95 transition-transform duration-200 cursor-pointer group">
                    <div class="relative w-full aspect-square bg-stone-100 rounded-2xl overflow-hidden mb-3">
                        <img src="${p.Image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.src='https://placehold.co/400x400?text=No+Image'">
                        <div class="absolute bottom-2 right-2 bg-white/90 backdrop-blur rounded-full w-8 h-8 flex items-center justify-center shadow-sm">
                            <svg class="w-4 h-4 text-stone-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        </div>
                    </div>
                    <h4 class="font-bold text-stone-800 leading-tight mb-1 truncate">${p.Name}</h4>
                    <p class="text-orange-600 font-black tracking-wide">$${p.Price}</p>
                </div>
            `).join('');
        }

        let currentModalProduct = null;
        let currentModalSpecs = {}; // { 'å£å‘³': 'åŸå‘³' }

        function openProductModal(pid) {
            const p = appState.products.find(x => x.ID === pid);
            if (!p) return;

            currentModalProduct = p;
            currentModalSpecs = {};

            // Parse specs
            let specsHtml = '';
            try {
                const specs = JSON.parse(p.Specs || '{}');
                // Auto select first option
                Object.keys(specs).forEach(k => currentModalSpecs[k] = specs[k][0]);

                specsHtml = Object.entries(specs).map(([key, vals]) => `
                    <div class="space-y-2">
                        <p class="text-xs font-bold text-stone-400 uppercase tracking-wider">${key}</p>
                        <div class="flex flex-wrap gap-2">
                            ${vals.map(v => `
                                <button onclick="selectSpec('${key}', '${v}')" 
                                    class="spec-btn spec-${key}-${v} px-4 py-2 rounded-xl border-2 font-bold text-sm transition-all ${currentModalSpecs[key] === v ? 'border-stone-800 bg-stone-800 text-white' : 'border-stone-100 bg-white text-stone-500'}">
                                    ${v}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (e) { }

            const content = `
                <div class="flex gap-4 items-start">
                    <div class="w-24 h-24 bg-stone-100 rounded-2xl overflow-hidden flex-shrink-0">
                         <img src="${p.Image}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x400'">
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-stone-900 leading-tight mb-1">${p.Name}</h2>
                        <p class="text-orange-600 font-black text-xl mb-2">$${p.Price}</p>
                        <span class="text-[10px] bg-stone-100 text-stone-500 px-2 py-1 rounded-md font-bold">${p.Category}</span>
                    </div>
                </div>
                <hr class="border-stone-100">
                ${specsHtml}
                <!-- Quantity -->
                <div class="bg-stone-50 p-4 rounded-2xl flex items-center justify-between">
                    <span class="font-bold text-stone-600">è³¼è²·æ•¸é‡</span>
                    <div class="flex items-center gap-4 bg-white px-2 py-1 rounded-xl shadow-sm border border-stone-100">
                        <button onclick="updateModalQty(-1)" class="w-8 h-8 flex items-center justify-center text-stone-400 hover:text-stone-800 font-bold text-xl">-</button>
                        <span id="modal-qty" class="w-8 text-center font-black text-lg">1</span>
                        <button onclick="updateModalQty(1)" class="w-8 h-8 flex items-center justify-center text-stone-400 hover:text-stone-800 font-bold text-xl">+</button>
                    </div>
                </div>
            `;

            document.getElementById('product-modal-content').innerHTML = content;
            document.getElementById('product-modal').classList.remove('hidden');
            document.querySelector('#product-modal > div:nth-child(2)').classList.remove('translate-y-full');
        }

        function selectSpec(key, val) {
            currentModalSpecs[key] = val;
            // Update UI
            document.querySelectorAll(`.spec-btn[class*="spec-${key}-"]`).forEach(el => {
                el.classList.remove('border-stone-800', 'bg-stone-800', 'text-white');
                el.classList.add('border-stone-100', 'bg-white', 'text-stone-500');
            });
            const activeBtn = document.querySelector(`.spec-${key}-${val}`);
            activeBtn.classList.remove('border-stone-100', 'bg-white', 'text-stone-500');
            activeBtn.classList.add('border-stone-800', 'bg-stone-800', 'text-white');
        }

        function updateModalQty(delta) {
            const el = document.getElementById('modal-qty');
            let v = parseInt(el.innerText) + delta;
            if (v < 1) v = 1;
            el.innerText = v;
        }

        function closeProductModal() {
            document.querySelector('#product-modal > div:nth-child(2)').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('product-modal').classList.add('hidden'), 300);
        }

        // --- Cart Logic ---
        function addToCart() {
            if (!currentModalProduct) return;
            const qty = parseInt(document.getElementById('modal-qty').innerText);

            // Create item ID based on product + specs
            const specStr = JSON.stringify(currentModalSpecs);
            const existingIdx = appState.cart.findIndex(i => i.pid === currentModalProduct.ID && JSON.stringify(i.spec) === specStr);

            if (existingIdx >= 0) {
                appState.cart[existingIdx].qty += qty;
            } else {
                appState.cart.push({
                    pid: currentModalProduct.ID,
                    name: currentModalProduct.Name,
                    price: currentModalProduct.Price,
                    image: currentModalProduct.Image,
                    spec: { ...currentModalSpecs },
                    qty: qty
                });
            }

            saveCart();
            closeProductModal();
            updateUI();

            // Animation
            confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 }, colors: ['#ea580c', '#f5f5f4'] });
        }

        function updateCartQty(idx, delta) {
            appState.cart[idx].qty += delta;
            if (appState.cart[idx].qty <= 0) {
                appState.cart.splice(idx, 1);
            }
            saveCart();
            renderCartItems(); // Re-render
            updateUI();
        }

        function loadCart() {
            const c = localStorage.getItem('ordering_cart');
            if (c) appState.cart = JSON.parse(c);
        }

        function saveCart() {
            localStorage.setItem('ordering_cart', JSON.stringify(appState.cart));
        }

        function openCart() {
            renderCartItems();
            document.getElementById('cart-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('cart-panel').classList.remove('translate-y-full'), 10);

            // Reset to List View
            document.getElementById('cart-items-container').classList.remove('hidden');
            document.getElementById('checkout-form').classList.add('hidden');
            document.getElementById('checkout-btn').innerHTML = `<span>å‰å¾€çµå¸³</span><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>`;
            document.getElementById('checkout-btn').setAttribute('onclick', 'proceedToCheckout()');
            document.getElementById('cart-title').innerText = 'è³¼ç‰©è»Š';
        }

        function closeCart() {
            document.getElementById('cart-panel').classList.add('translate-y-full');
            setTimeout(() => document.getElementById('cart-modal').classList.add('hidden'), 300);
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            if (appState.cart.length === 0) {
                container.innerHTML = '<div class="text-center py-20 text-stone-300 font-bold">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>';
                return;
            }

            container.innerHTML = appState.cart.map((item, idx) => {
                const specText = Object.values(item.spec).join(' / ');
                // URL Validation (Simple check)
                const imgUrl = (item.image && item.image.startsWith('http')) ? item.image : 'https://placehold.co/200x200?text=No+Image';

                return `
                <div class="flex gap-4 items-center bg-white p-3 rounded-2xl shadow-sm border border-stone-50">
                    <img src="${imgUrl}" class="w-16 h-16 rounded-xl bg-stone-100 object-cover flex-shrink-0" onerror="this.src='https://placehold.co/200x200?text=Error'">
                    <div class="flex-grow min-w-0">
                        <h4 class="font-bold text-stone-800 truncate">${item.name}</h4>
                        <p class="text-xs text-stone-400 mb-1">${specText}</p>
                        <p class="text-orange-600 font-bold">$${item.price}</p>
                    </div>
                    <div class="flex items-center gap-2 bg-stone-100 rounded-lg p-1">
                        <button onclick="updateCartQty(${idx}, -1)" class="w-6 h-6 flex items-center justify-center font-bold text-stone-500">-</button>
                        <span class="text-sm font-bold w-4 text-center">${item.qty}</span>
                        <button onclick="updateCartQty(${idx}, 1)" class="w-6 h-6 flex items-center justify-center font-bold text-stone-500">+</button>
                    </div>
                </div>
                `;
            }).join('');

            updateCartTotal();
        }

        // --- Checkout Flow ---
        function setMethod(m) {
            appState.shippingMethod = m;

            // Buttons UI
            ['store', 'home', 'self'].forEach(x => {
                const btn = document.getElementById(`btn-method-${x}`);
                const content = document.getElementById(`form-${x}`);

                if (x === m) {
                    btn.classList.add('border-stone-800', 'text-stone-800', 'bg-stone-50');
                    btn.classList.remove('border-stone-100', 'text-stone-500');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.remove('border-stone-800', 'text-stone-800', 'bg-stone-50');
                    btn.classList.add('border-stone-100', 'text-stone-500');
                    content.classList.add('hidden');
                }
            });

            updateCartTotal();
        }

        function proceedToCheckout() {
            if (appState.cart.length === 0) return;

            // Switch View
            document.getElementById('cart-items-container').classList.add('hidden');
            document.getElementById('checkout-form').classList.remove('hidden');
            document.getElementById('cart-title').innerText = 'å¡«å¯«è¨‚å–®';

            // Change Button to Submit
            const btn = document.getElementById('checkout-btn');
            btn.innerHTML = `<span>ç¢ºèªé€å‡ºè¨‚å–®</span><svg class="w-5 h-5 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
            btn.setAttribute('onclick', 'submitOrder()');

            // Init Method UI
            setMethod(appState.shippingMethod);
        }

        async function submitOrder() {
            // Validation
            const name = document.getElementById('input-r-name').value.trim();
            const phone = document.getElementById('input-r-phone').value.trim();
            const method = appState.shippingMethod;

            let finalAddress = '';

            // Validate & Build Address
            if (!name || !phone) { alert('è«‹å¡«å¯«å®Œæ•´æ”¶ä»¶äººè³‡æ–™'); return; }

            if (method === 'store') {
                const type = document.getElementById('store-type').value;
                const city = document.getElementById('store-city').value;
                const dist = document.getElementById('store-dist').value;
                const store = document.getElementById('store-name').value.trim();
                if (!city || !dist || !store) { alert('è«‹å®Œæ•´å¡«å¯«å–è²¨é–€å¸‚è³‡è¨Š (ç¸£å¸‚ã€å€åŸŸã€é–€å¸‚åç¨±)'); return; }
                finalAddress = `[${type}] ${city}${dist} - ${store}`;
            }
            else if (method === 'home') {
                const city = document.getElementById('home-city').value;
                const dist = document.getElementById('home-dist').value;
                const addr = document.getElementById('home-addr').value.trim();
                if (!city || !dist || !addr) { alert('è«‹å®Œæ•´å¡«å¯«å®…é…åœ°å€ (å«ç¸£å¸‚å€åŸŸ)'); return; }
                finalAddress = `${city}${dist}${addr}`;
            }
            else if (method === 'self') {
                const time = document.getElementById('self-time').value;
                if (!time) { alert('è«‹é¸æ“‡é è¨ˆå–è²¨æ™‚é–“'); return; }
                finalAddress = `è‡ªå–æ™‚é–“: ${time.replace('T', ' ')}`;
            }

            const btn = document.getElementById('checkout-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'è™•ç†ä¸­...';
            btn.disabled = true;

            // Calculate amounts
            const subtotal = appState.cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            let shipping = 0;
            if (method === 'home') shipping = parseInt(appState.settings.ShippingFee_Home || 0);
            if (method === 'store') shipping = parseInt(appState.settings.ShippingFee_Store || 0);

            const payload = {
                action: 'submitOrder',
                data: {
                    memberId: appState.user.userId,
                    memberName: appState.user.displayName,
                    recipientName: name,
                    recipientPhone: phone,
                    method: method,
                    address: finalAddress,
                    items: appState.cart,
                    total: subtotal + shipping,
                    note: 'Ordered via Web'
                }
            };

            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if (json.result === 'success') {
                    // Success
                    appState.cart = [];
                    saveCart();
                    updateUI();
                    closeCart();

                    // Success Modal / Alert
                    alert(`ğŸ‰ è¨‚è³¼æˆåŠŸï¼\nè¨‚å–®ç·¨è™Ÿ: ${json.orderId}`);
                    window.location.reload(); // Reload to reset state
                } else {
                    throw new Error(json.message);
                }
            } catch (e) {
                alert('è¨‚å–®é€å‡ºå¤±æ•—: ' + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function updateCartTotal() {
            const subtotal = appState.cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            let shipping = 0;
            if (appState.shippingMethod === 'home') shipping = parseInt(appState.settings.ShippingFee_Home || 0);
            if (appState.shippingMethod === 'store') shipping = parseInt(appState.settings.ShippingFee_Store || 0);

            document.getElementById('cart-total').innerText = `$${subtotal + shipping}`;

            // Only update subtotal if not in checkout mode (optional logic, kept simple here)
        }

        function updateUI() {
            const count = appState.cart.reduce((sum, i) => sum + i.qty, 0);
            document.getElementById('cart-count').innerText = count;


            const btn = document.getElementById('cart-btn');
            if (count > 0 && appState.mode === 'buy') {
                btn.classList.remove('translate-y-20', 'opacity-0');
            } else {
                btn.classList.add('translate-y-20', 'opacity-0');
            }
        }

        // --- Sell Mode Logic ---
        function toggleMode() {
            appState.mode = appState.mode === 'buy' ? 'sell' : 'buy';
            const isSell = appState.mode === 'sell';

            // UI Toggle
            document.querySelector('main').classList.toggle('hidden', isSell); // Buy View
            document.getElementById('sell-view').classList.toggle('hidden', !isSell);
            document.getElementById('cart-btn').classList.add('translate-y-20', 'opacity-0'); // Hide cart in sell mode

            // Button Update
            const btn = document.getElementById('mode-btn');
            if (isSell) {
                btn.innerHTML = `<span>é€›é€›å•†å“</span><svg class="w-3 h-3 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>`;
                btn.classList.replace('bg-stone-800', 'bg-orange-600');
            } else {
                btn.innerHTML = `<span>æˆ‘è¦è³£æ±è¥¿</span><svg class="w-3 h-3 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>`;
                btn.classList.replace('bg-orange-600', 'bg-stone-800');
                updateUI(); // Restore cart btn if needed
            }

            // Title Update
            document.getElementById('store-name').innerHTML = isSell
                ? `<span class="text-2xl">ğŸª</span> è³£å®¶ä¸­å¿ƒ`
                : `<span class="text-2xl">ğŸ›ï¸</span> ${appState.settings.StoreName || 'Store'}`;
        }

        let uploadImageBase64 = null;

        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('preview-img').classList.remove('hidden');
                    uploadImageBase64 = e.target.result; // Data URL
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addSpecLine() {
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                <input type="text" placeholder="è¦æ ¼åç¨±" class="spec-key w-1/3 bg-stone-50 text-xs font-bold p-2 rounded-lg outline-none">
                <input type="text" placeholder="é¸é … (ç”¨é€—è™Ÿéš”é–‹)" class="spec-vals flex-grow bg-stone-50 text-xs font-bold p-2 rounded-lg outline-none">
            `;
            document.getElementById('specs-container').appendChild(div);
        }

        async function submitProduct() {
            if (!uploadImageBase64) { alert('è«‹ä¸Šå‚³å•†å“åœ–ç‰‡'); return; }

            const btn = document.getElementById('submit-prod-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ä¸Šæ¶ä¸­...';
            btn.disabled = true;

            // Build Specs Object
            const specs = {};
            document.querySelectorAll('#specs-container > div').forEach(div => {
                const key = div.querySelector('.spec-key').value.trim();
                const valStr = div.querySelector('.spec-vals').value.trim();
                if (key && valStr) {
                    specs[key] = valStr.split(',').map(s => s.trim()).filter(x => x);
                }
            });

            const payload = {
                action: 'createProduct',
                data: {
                    imageBase64: uploadImageBase64,
                    name: document.getElementById('prod-name').value,
                    price: document.getElementById('prod-price').value,
                    category: document.getElementById('prod-cat').value,
                    specs: specs,
                    sellerId: appState.user.userId,
                    sellerName: appState.user.displayName
                }
            };

            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const json = await res.json();

                if (json.result === 'success') {
                    alert('âœ… å•†å“ä¸Šæ¶æˆåŠŸï¼');
                    // Reset Form
                    document.getElementById('sell-form').reset();
                    document.getElementById('preview-img').classList.add('hidden');
                    uploadImageBase64 = null;

                    // Refresh Data & Switch to Buy Mode to see it
                    fetchData(); // Background refresh
                    toggleMode();
                } else {
                    throw new Error(json.message);
                }
            } catch (e) {
                alert('ä¸Šæ¶å¤±æ•—: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

    </script>
</body>

</html>
